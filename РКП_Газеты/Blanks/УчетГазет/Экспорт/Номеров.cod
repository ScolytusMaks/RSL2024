class inherited РКП_Газеты.УчетГазет.Экспорт.Газет "Экспорт номеров газет в банк данных РКП", editor ЭкспортВБанкДанныхНомеров;
Import РКП_СИС Classes StdCode;

inclass

inobject
  proc ВычислитьИмяФайла;
  var Q                         : Query;
----Определение даты последнего экспорта газет-------------------------------------------------------------
  Q                             = Query.Create([РКП_Газеты.ЭкспортВБанкДанныхНомеров]);
  Q.Filter                      = "ДатаЗаписиВФайл<"+Str(Dat(Day(Now(true)),Mon(Now(true)),Year(Now(true))))+
                                  " and Year(ДатаЗаписиВФайл)="+Str(Year(Now(true)));
  Q.Order                       = "ДатаЗаписиВФайл";
  Q.Select;
  if Q.Count = 0                                                then
    НомерСеансаВГоду            = 1;
  else
    Q.Last;
    НомерСеансаВГоду            = Q.Current.НомерСеансаВГоду+1;
  end;
----Определение имен файла и папки-------------------------------------------------------------------------
  if ДатаЗаписиВФайл<>nil and ГодСеанса>2000 and КварталСеанса>0        then
    ПапкаФайлаЭкспорта          = "C:\ЭКСПОРТ\НОМЕРА_ГАЗЕТ\"+Str(ГодСеанса);
    ФайлЭкспорта                = "C:\ЭКСПОРТ\НОМЕРА_ГАЗЕТ\"+Str(ГодСеанса)+
                                   "\gzt-"+SubStr(Str(ГодСеанса),3,2)+
                                   "-"+
                                   FixStr(Str(КварталСеанса),"0",2)+
                                   ".rlg";
  end;
  end;--proc ВычислитьИмяФайла;


  proc РасчетСтатистикиВыпуска(Газета                   :record;
                               ГодВыпуска               :integer;
                               var НомеровПолученоВ     :integer;--для приведения к стандарту размерности,
                               var ГодовойТиражВ        :numeric;--принятому после 2006 года. При этом полученные величины
                               var СреднийРазовыйТиражВ :numeric;--могут отличаться от опубликованных!!!
                               var ВаловыйНомерВ        :string;
                               var КомментарийВ         :string
                                );
  var Q :Query;
      Q                                 = Query.Create([РКП_Газеты.НомерГазеты]);--Обработка запроса по номерам для вычисления тиража поступлений
      Q.Filter                          = "Газета="+Str(Газета)+
                                          " and ГодВыпуска="+Str(ГодВыпуска)+
                                          " and not НеПолучен"+
                                          " and isGroup=0";
      Q.LoadingFields                   = "Тираж";
      Q.Select;
        НомеровПолученоВ                = Q.Count;
        if НомеровПолученоВ > 0                 then
          ГодовойТиражВ                 = Q.CalcAggregates("Sum(Тираж)")/1000;
          СреднийРазовыйТиражВ          = Round(ГодовойТиражВ/НомеровПолученоВ,1);
          ГодовойТиражВ                 = Round(ГодовойТиражВ,1);
          Q.Last;
          ВаловыйНомерВ                 = Q.Current.ВаловыйНомер;
          КомментарийВ                  = Q.Current.Комментарий;
        end; --НомеровПолученоВ>0
      Q.Close;
  end;


--------------------------------------------------------------------------------
--{ Обработчики событий бланка

--\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
  func СоздатьФайлЭкспорта(Cell :TemplateCell; Action :Template.ClickTypes):Logical;
    var НОМ                     : TextFile;
    var Q,Qn                    : Query;
    var k,kk,z,zz,m             : integer;
    var РешениеПродолжить       : Logical;
    var НомеровПолученоВ        :integer;
    var ГодовойТиражВ           :numeric;
    var СреднийРазовыйТиражВ    :numeric;
    var ВаловыйНомерВ           :string;
    var КомментарийВ            :string;



  if ИзмененияЗапрещены = false                                 then
----Проверка правильности заданых года и квартала----------------------------------------------------------
  if ГодСеанса>2000                                                     then
    if КварталСеанса>0                                                  then
      РешениеПродолжить         = true;
      ДатаЗаписиВФайл           = Now(true);
      ВычислитьИмяФайла;
    else
      Message("Пожалуйста, укажите квартал!");
    end;
  else
    Message("Год экспорта должен быть позже 2000!");
  end;
----Процедура выгрузки номеров-----------------------------------------------------------------------------
  if РешениеПродолжить=true                                             then
    if ExistFolder(ПапкаФайлаЭкспорта)=false                            then
      CreateFolder(ПапкаФайлаЭкспорта);
    end;
    if ExistFile(ФайлЭкспорта)=true                                     then
      RemoveFile(ФайлЭкспорта);
    end;
    НОМ                         = TextFile.Create(ФайлЭкспорта,fmCreate,false);   --28.01.2009 - в кодировке DOS
      --запрос по статистике выпуска с проверкой наличия номеров
      Q                         = Query.Create([РКП_Газеты.ВыпускГазеты]);
      Q.LoadingFields           = "ГодВыпуска;Периодичность;ФорматВыпуска;ЧислоПолос;СреднийРазовыйТираж;ГодовойТираж;Комментарий";
      Q.Order                   = "Газета;ГодВыпуска";
      Q.Select;
      kk                        = Q.Count;
      Q.First;
      --цикл по статистике выпуска с проверкой наличия номеров
      for k = 1..kk                                                     do
        Hint("Создание файла ...",k,kk);
      --запрос к номерам с проверкой количества
        Qn                      = Query.Create([РКП_Газеты.НомерГазеты]);
        Qn.LoadingFields        = "ГодВыпуска;Номер;ВаловыйНомер;ДатаВыхода;Тираж;ТочностьДатыВыхода;ДатаПринятияНаХранение";
        if    КварталСеанса=1                                           then
          Qn.Filter             = "ГодВыпуска="+Str(Q.Current.ГодВыпуска)+" and isGroup=0 and Газета="+Str(Q.Current.Газета)+" and ДатаПринятияНаХранение>"+Str(Dat(1,1,ГодСеанса)-1)+" and "+"ДатаПринятияНаХранение<"+Str(Dat(1,4,ГодСеанса));
        elsif КварталСеанса=2                                          then
          Qn.Filter             = "ГодВыпуска="+Str(Q.Current.ГодВыпуска)+" and isGroup=0 and Газета="+Str(Q.Current.Газета)+" and ДатаПринятияНаХранение>"+Str(Dat(1,4,ГодСеанса)-1)+" and "+"ДатаПринятияНаХранение<"+Str(Dat(1,7,ГодСеанса));
        elsif КварталСеанса=3                                          then
          Qn.Filter             = "ГодВыпуска="+Str(Q.Current.ГодВыпуска)+" and isGroup=0 and Газета="+Str(Q.Current.Газета)+" and ДатаПринятияНаХранение>"+Str(Dat(1,7,ГодСеанса)-1)+" and "+"ДатаПринятияНаХранение<"+Str(Dat(1,10,ГодСеанса));
        elsif КварталСеанса=4                                          then
          Qn.Filter             = "ГодВыпуска="+Str(Q.Current.ГодВыпуска)+" and isGroup=0 and Газета="+Str(Q.Current.Газета)+" and ДатаПринятияНаХранение>"+Str(Dat(1,10,ГодСеанса)-1)+" and "+"ДатаПринятияНаХранение<"+Str(Dat(31,12,ГодСеанса)+1);
        end;
        Qn.Order                = "ГодВыпуска;СерияНумерации;Номер";
        Qn.Select;
        zz                      = Qn.Count;
        if zz>0                                                         then
          m                     = m+1;
    НОМ.WriteLn("000 "+FixStr(Str(m),"0",6));
    --поле для контроля
    if Q.Current.Газета.Подзаголовок = nil                              then
    НОМ.WriteLn("900 "+Q.Current.Газета.НазваниеОсн);
    else
    НОМ.WriteLn("900 "+Q.Current.Газета.НазваниеОсн+" ^: "+Q.Current.Газета.Подзаголовок);
    end;--поле для контроля
    НОМ.WriteLn("004 " + РКП_СИС.StdCode.FixStr(Str(Q.Current.Газета.DocId),"0",10));
    РасчетСтатистикиВыпуска(Q.Current.Газета,
                            Q.Current.ГодВыпуска,
                            НомеровПолученоВ,
                            ГодовойТиражВ,
                            СреднийРазовыйТиражВ,
                            ВаловыйНомерВ,
                            КомментарийВ);
    НОМ.WriteLn("208 ^a"+Str(Q.Current.ГодВыпуска));
    НОМ.WriteLn("208 ^b"+Q.Current.Периодичность);
    НОМ.WriteLn("208 ^c"+Q.Current.ФорматВыпуска);
    НОМ.WriteLn("208 ^d"+Q.Current.ЧислоПолос);
    НОМ.WriteLn("208 ^e"+Str(СреднийРазовыйТиражВ,1));
    НОМ.WriteLn("208 ^f"+Str(ГодовойТиражВ,1));
    НОМ.WriteLn("208 ^g"+Str(НомеровПолученоВ));
    if ВаловыйНомерВ<>""                                                then
    НОМ.WriteLn("208 ^h"+ВаловыйНомерВ);
    end;
    if КомментарийВ<>""                                                 then
    НОМ.WriteLn("208 ^i"+КомментарийВ);
    end;
          --цикл по номерам
          Qn.First;
          for z = 1..zz                                                 do
            if Qn.Current.ВаловыйНомер<>nil                             then
    НОМ.WriteLn("246 "+Qn.Current.Номер+" ^:"+Qn.Current.ВаловыйНомер);
            else
    НОМ.WriteLn("246 "+Qn.Current.Номер);
            end;
            if Qn.Current.ДатаВыхода<>nil and Qn.Current.ТочностьДатыВыхода=0   then
    НОМ.WriteLn("262 ^,"+Qn.Current.Номер);
            end;
            if Qn.Current.Тираж<>nil                                    then
    НОМ.WriteLn("573 "+Str(Qn.Current.Тираж));
            end;
            Qn.Next;
          end;
        --*Qn.Close;
          --конец цикла по номерам
          if k < kk                                                     then --вставка сепаратора
    НОМ.WriteLn("___");
          end;
        else
        --*Qn.Close;
        end;
      --конец запроса к номерам с проверкой количества
      Q.Next;
      end;
      --конец цикла по статистике выпуска с проверкой наличия номеров
      Q.Close;
      --конец запроса по статистике выпуска с проверкой наличия номеров



--      Q                         = Query.Create([РКП_Газеты.НомерГазеты]);
--      if    КварталСеанса=1                                             then
--      Q.Filter                  = "ДатаПринятияНаХранение>"+Str(Dat(1,1,ГодСеанса)-1)+
--                                  " and "+
--                                  "ДатаПринятияНаХранение<"+Str(Dat(1,4,ГодСеанса));
--      elsif КварталСеанса=2                                             then
--      Q.Filter                  = "ДатаПринятияНаХранение>"+Str(Dat(1,4,ГодСеанса)-1)+
--                                  " and "+
--                                  "ДатаПринятияНаХранение<"+Str(Dat(1,7,ГодСеанса));
--      elsif КварталСеанса=3                                             then
--      Q.Filter                  = "ДатаПринятияНаХранение>"+Str(Dat(1,7,ГодСеанса)-1)+
--                                  " and "+
--                                  "ДатаПринятияНаХранение<"+Str(Dat(1,10,ГодСеанса));
--      elsif КварталСеанса=4                                             then
--      Q.Filter                  = "ДатаПринятияНаХранение>"+Str(Dat(1,10,ГодСеанса)-1)+
--                                  " and "+
--                                  "ДатаПринятияНаХранение<"+Str(Dat(31,12,ГодСеанса)+1);
--      end;
--      Q.Order                   = "Газета.НаимОсн";
--      Q.Select;
--      kk                        = Q.Count;
--      for k = 1..kk                                                     do
--      -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--        Hint("Создание файла ...",k,kk);
--    НОМ.WriteLn("000 "+FixStr(Str(k),"0",6));
--    НОМ.WriteLn("004 "+РКП_СИС.КодСортировки.FixStr(Str(R.DocId),"0",10);
--    НОМ.WriteLn("208 "+"Данные по газете за год");
--        if k < kk                                     then --вставка сепаратора
--    НОМ.WriteLn("_");
--        end;
--      --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
--        Q.Current.ДатаЗаписиВФайлГЗ     = ДатаЗаписиВФайл;
--        Q.Next;
--      end;
--      Q.Close;
  else
    Message("Файл не создан.");
  end;--решение о выполнении экспорта



------Определение даты последнего экспорта газет-------------------------------------------------------------
----      Q                         = Query.Create([РКП_Газеты.ЭкспортВБанкДанныхНомеров]);
----      Q.Filter                  = "ДатаЗаписиВФайл<"+Str(Now(true));    --точка отсчета - системное время сервера
----      Q.Order                   = "ДатаЗаписиВФайл";
----      Q.Select;
----      if Q.Count > 0                                            then
----        Q.Last;
----        ДатаПоследнегоЭкспорта  = Q.Current.ДатаЗаписиВФайл;
----      else
----        ДатаПоследнегоЭкспорта  = nil;
----      end;
----      Q.Close;
------Принятие решения об экспорте и определение момента экспорта (даты)-------------------------------------
--      Q                         = Query.Create([РКП_Газеты.НомерГазеты]);
--      if ДатаПоследнегоЭкспорта = nil                           then
--        Q.Filter                = "UpdateDate<="+Str(Now(true))+         --точка отсчета - системное время сервера
--                                  " and ЭкспортРКП.Count>0";
--      else
--        Q.Filter                = "UpdateDate<="+Str(Now(true))+
--                                  " and UpdateDate>"+Str(ДатаПоследнегоЭкспорта-1)+
--                                  " and ЭкспортРКП.Count>0";
--      end;
--      Q.Select;
--      if Q.Count>0                                              then
--        РешениеПродолжить       = true;
--        ДатаЗаписиВФайл         = Now(true);
--      end;
--      Q.Close;
------Создание файла-----------------------------------------------------------------------------------------
--    if РешениеПродолжить = true                                 then
--    if    ExistFolder(ПапкаФайлаЭкспорта) = false                then
--      CreateFolder(ПапкаФайлаЭкспорта);
--    end;
--    if  ExistFile(ФайлЭкспорта)= true                           then
--      RemoveFile(ФайлЭкспорта);
--    end;
--    ГАЗ         = TextFile.Create(ФайлЭкспорта,fmCreate);
--      Q                         = Query.Create([РКП_Газеты.Газета]);
--      if ДатаПоследнегоЭкспорта = nil                           then
--        Q.Filter                = "UpdateDate<="+Str(Now(true))+         --точка отсчета - системное время сервера
--                                  " and ЭкспортРКП.Count>0";
--      else
--        Q.Filter                = "UpdateDate<="+Str(Now(true))+
--                                  " and UpdateDate>"+Str(ДатаПоследнегоЭкспорта-1)+
--                                  " and ЭкспортРКП.Count>0";

--      end;
--      Q.Order                   = "НазваниеОсн";
--      Q.Select;
--      kk                        = Q.Count;
--      if  kk > 0                                        then
--        Q.First;
--        for k = 1..kk                                   do --начало перебора газет
--          Hint("Создание файла ..",k,kk);
--          zz                   = Q.Current.ЭкспортРКП.Count;
--          for z = 1..zz                                 do
--              ГАЗ.WriteLn(Q.Current.ЭкспортРКП.Items[z].Данные);
--          end;
--          if k >1                                       then --вставка сепаратора
--                ГАЗ.WriteLn("_");
--          end;
--        Q.Next;
--        end;--цикл перебора газет
--      end;--условие на непустую выборку
--      Q.Close;--запрос по газетам
--      Message("Обработано записей:      "+Str(kk));
--    else
--      Message("Файл не создан: не найдены газеты, подготовленные для экспорта.");
--    end;--решение о выполнении экспорта
  else
    Message("Изменение файла запрещено!");
  end;
    Result = True; 
  end;--СоздатьФайлЭкспорта
--\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

  func ОткрытьЭкспортFold(Cell :TemplateCell; Action :Template.ClickTypes):Logical;
    ExecuteProgram(ПапкаФайлаЭкспорта);
    Result = True; 
  end;

  proc ОбработатьВсеГазеты(Sender :Button);
    var Q                       : Query;
    var k,kk                    : integer;
    var ЭкспортРКПДанные_[]     : string;
    var КолСтрок                : integer;
      Q                         = Query.Create([РКП_Газеты.Газета]);
      Q.Filter                  = "ПризнакОтсылки = false";
      Q.Select;
      kk                        = Q.Count;
      Q.First;
      for k = 1..kk             do
        Hint("Обработка газет...",k,kk);
        if  Q.Current.ЭкспортРКП.Count=0                then
        ЭкспортРКПДанные_       = nil;
        РКП_Газеты.Экспорт.Газет.СоздатьЗаписьРКП(Q.Current,ЭкспортРКПДанные_,КолСтрок);
        РКП_Газеты.Экспорт.Газет.Синхронизация(Q.Current,ЭкспортРКПДанные_);
        if Q.Current.State = Q.Current.Edited           then
          Q.Current.Post;
        end;
        end;
        Q.Next;
      end;
      Q.Close;
      Beep;
      Message("Ok!");
      
  end;



  func ПолеКварталСеансаПриПроверке(Cell :TemplateCell; Index :Integer;var Value :Variant) :Logical;
  var Q                 : Query;
      Q                         = Query.Create([РКП_Газеты.ЭкспортВБанкДанныхНомеров]);
      Q.Filter                  = "ГодСеанса="+Str(ГодСеанса)+"and КварталСеанса="+Str(Value);
      Q.Select;
        if Q.Count=0                                                    then
          Result = True;
        else
          Message("Пожалуйста, правильно укажите квартал! В журнале экспорта номеров допускается один сеанс за один квартал!");
          Result = False;
        end;
      Q.Close;
  end;

--}

end