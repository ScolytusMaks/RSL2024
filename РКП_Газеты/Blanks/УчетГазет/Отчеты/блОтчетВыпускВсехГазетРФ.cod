class inherited РКП_Газеты.УчетГазет.Отчеты.блОтчетСтатРГБазовый2 "Выпуск газет в Российской Федерации";

import СИС2 classes СтроковыеФункции;

inobject private

--{{ 2_Свойства

  var РазовыйТираж1 :numeric[];
  const StartYear :Integer = 1940;
--}}

-- 2_Обработчики событий шаблона0. --

-- 2_Обработчики событий клеток шаблона0. --

  func ПолеЗаГодПриПроверке(Cell :TemplateCell; Index :Integer; var Value :Variant):Logical;
    if (Int(Value) < 2008) then
      Message('Допускается ввод значения >= 2008!');
      Return false;
    else
      Return true;
    fi;
  end;

-- 2_Обработчики событий прочих объектов шаблона0. --

  proc кнЭкспортПриНажатии(Sender :Button);
    try
    Template.CellByField['СодержаниеСтроки'].SetFocus;
    except 
    end;
    ExecuteCommand('Kernel.File.Export');
  end;

-- 2_Вспомогательные методы0. --

  proc 2_ПостроениеОтчета0.;
    ОтчетСоздан = Now;
    if (SessionInfo.UserRecord <> nil) then
      Библиограф = SessionInfo.UserRecord.FullName;
    fi;
    ОчиститьРезультатыРасчета;
    ПостроениеОтчета_АрхивныеДанные;
    ПостроениеОтчета_НовыеДанные;
    УдалитьПустыеСтроки;
  end;

  proc ОчиститьРезультатыРасчета;
    inherited ОчиститьРезультатыРасчета;
    РазовыйТираж1 = nil;
  end;

  proc ПостроениеОтчета_АрхивныеДанные; -- Данные за периоды 1940-2000 (шаг 10 лет) и 2001-2008 гг. - без изменений
    var vHeaderHint :string;
    var yy :integer;
    vHeaderHint = '1940 - 2008 гг. ';
    yy = (ЗаГод - StartYear);
    секцПозиции.FramesCount = 15;
    СодержаниеСтроки[01] = '1940'; КолГазет[01] = 5730; КолНомеров[01] = 604268; РазовыйТираж[01] = 25126;    ГодовойТираж[01] = 5094619;   РазовыйТираж1[01] = 4.4;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[01] + ' / ' + Str(ЗаГод) + ' ]' , 1940 + 1 - StartYear, yy);
    СодержаниеСтроки[02] = '1950'; КолГазет[02] = 5021; КолНомеров[02] = 543290; РазовыйТираж[02] = 25451;    ГодовойТираж[02] = 5048429;   РазовыйТираж1[02] = 5.1;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[02] + ' / ' + Str(ЗаГод) + ' ]' , 1950 + 1 - StartYear, yy);
    СодержаниеСтроки[03] = '1960'; КолГазет[03] = 4474; КолНомеров[03] = 585561; РазовыйТираж[03] = 45629;    ГодовойТираж[03] = 11053327;  РазовыйТираж1[03] = 10.2; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[03] + ' / ' + Str(ЗаГод) + ' ]' , 1960 + 1 - StartYear, yy);
    СодержаниеСтроки[04] = '1970'; КолГазет[04] = 4445; КолНомеров[04] = 568719; РазовыйТираж[04] = 93715;    ГодовойТираж[04] = 22766660;  РазовыйТираж1[04] = 21.1; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[04] + ' / ' + Str(ЗаГод) + ' ]' , 1970 + 1 - StartYear, yy);
    СодержаниеСтроки[05] = '1980'; КолГазет[05] = 4413; КолНомеров[05] = 502822; РазовыйТираж[05] = 119574;   ГодовойТираж[05] = 29245100;  РазовыйТираж1[05] = 27.1; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[05] + ' / ' + Str(ЗаГод) + ' ]' , 1980 + 1 - StartYear, yy);
    СодержаниеСтроки[06] = '1990'; КолГазет[06] = 4808; КолНомеров[06] = 523866; РазовыйТираж[06] = 165546;   ГодовойТираж[06] = 3785263;   РазовыйТираж1[06] = 34.4; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[06] + ' / ' + Str(ЗаГод) + ' ]' , 1990 + 1 - StartYear, yy);
    СодержаниеСтроки[07] = '2000'; КолГазет[07] = 5758; КолНомеров[07] = 377280; РазовыйТираж[07] = 108273;   ГодовойТираж[07] = 7138919;   РазовыйТираж1[07] = 18.8; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[07] + ' / ' + Str(ЗаГод) + ' ]' , 2000 + 1 - StartYear, yy);
    СодержаниеСтроки[08] = '2001'; КолГазет[08] = 5532; КолНомеров[08] = 341692; РазовыйТираж[08] = 100133;   ГодовойТираж[08] = 5836530;   РазовыйТираж1[08] = 18.1; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[08] + ' / ' + Str(ЗаГод) + ' ]' , 2001 + 1 - StartYear, yy);
    СодержаниеСтроки[09] = '2002'; КолГазет[09] = 6663; КолНомеров[09] = 322684; РазовыйТираж[09] = 128870;   ГодовойТираж[09] = 6195774;   РазовыйТираж1[09] = 19.3; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[09] + ' / ' + Str(ЗаГод) + ' ]' , 2002 + 1 - StartYear, yy);
    СодержаниеСтроки[10] = '2003'; КолГазет[10] = 8086; КолНомеров[10] = 387684; РазовыйТираж[10] = 214165;   ГодовойТираж[10] = 10068231;  РазовыйТираж1[10] = 26.5; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[10] + ' / ' + Str(ЗаГод) + ' ]' , 2003 + 1 - StartYear, yy);
    СодержаниеСтроки[11] = '2004'; КолГазет[11] = 7517; КолНомеров[11] = 310060; РазовыйТираж[11] = 177350;   ГодовойТираж[11] = 7923043;   РазовыйТираж1[11] = 23.6; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[11] + ' / ' + Str(ЗаГод) + ' ]' , 2004 + 1 - StartYear, yy);
    СодержаниеСтроки[12] = '2005'; КолГазет[12] = 7535; КолНомеров[12] = 327581; РазовыйТираж[12] = 177238;   ГодовойТираж[12] = 7280618;   РазовыйТираж1[12] = 23.5; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[12] + ' / ' + Str(ЗаГод) + ' ]' , 2005 + 1 - StartYear, yy);
    СодержаниеСтроки[13] = '2006'; КолГазет[13] = 8250; КолНомеров[13] = 327103; РазовыйТираж[13] = 192347;   ГодовойТираж[13] = 8023919;   РазовыйТираж1[13] = 23.3; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[13] + ' / ' + Str(ЗаГод) + ' ]' , 2006 + 1 - StartYear, yy);
    СодержаниеСтроки[14] = '2007'; КолГазет[14] = 8516; КолНомеров[14] = 337887; РазовыйТираж[14] = 203929;   ГодовойТираж[14] = 7439902;   РазовыйТираж1[14] = 23.9; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[14] + ' / ' + Str(ЗаГод) + ' ]' , 2007 + 1 - StartYear, yy);
    СодержаниеСтроки[15] = '2008'; КолГазет[15] = 8978; КолНомеров[15] = 368795; РазовыйТираж[15] = 211970.6; ГодовойТираж[15] = 8214510.5; РазовыйТираж1[15] = 23.6; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[15] + ' / ' + Str(ЗаГод) + ' ]' , 2008 + 1 - StartYear, yy);
  end;

  proc ПостроениеОтчета_НовыеДанные; -- Данные за период начиная с 2009 года включительно
    var k, j, kk :integer;
    k = секцПозиции.FramesCount;
    kk = (ЗаГод - StartYear);
    for j = 2009 .. ЗаГод do
      k = k + 1;
      секцПозиции.InsertFrame(k);
      СодержаниеСтроки[k] = Str(j);
      if (ПравилоРасчетаСтатистики = Константы.статПравилоПоПоступлению) then
        РасчетПозиции_ПоступленияЗаПериод (k, [СодержаниеСтроки[k] + ' г. ', Int(СодержаниеСтроки[k]) + 1 - StartYear, kk]);
      else
        РасчетПозиции_ВыпускЗаПериод (k, [СодержаниеСтроки[k] + ' г. ', Int(СодержаниеСтроки[k]) + 1 - StartYear, kk]);
      fi;
    od;
  end;

  proc РасчетПозиции_ПоступленияЗаПериод (vLine :Integer; aHint :Variant[]);
    var vFlt :String;
    var aResult :Variant[];
    Hint(aHint[1] as string + ' [ ' + СодержаниеСтроки[vLine] + ' / ' + Str(ЗаГод) + ' ]' , aHint[2] as integer, aHint[3] as integer);
    vFlt = РасчетПозиции_ФильтрПоступленийЗаГод(vLine);
    aResult = РасчетПозиции_ПолучитьСтатистикуПоступленийЗаГод(vFlt);
    КолГазет[vLine]     = aResult[1];
    КолНомеров[vLine]   = aResult[2];
    РазовыйТираж[vLine] = aResult[3];
    ГодовойТираж[vLine] = aResult[4];
    if (КолГазет[vLine] > 0) then
      РазовыйТираж1[vLine] = Round(РазовыйТираж[vLine] / КолГазет[vLine], 1);
    fi;
  end;

  proc РасчетПозиции_ВыпускЗаПериод (vLine :Integer; aHint :Variant[]);
    var aResult :Variant[];
    var j, jj :integer;
    var vHint1, vHint2 :String;
    vHint1 = aHint[1] as string + ' [ ' + СодержаниеСтроки[vLine] + ' / ' + Str(ЗаГод) + ' ]';
    Hint(vHint1 + ' : Выполнение запроса...' , aHint[2] as integer, aHint[3] as integer);
    with Query.Create([РКП_Газеты.ПоступлениеГазеты]) do
      Filter = РасчетПозиции_ФильтрПоступленийЗаГод(vLine);
      LoadingFieldsMode = СИС2.Константы.mdNone;
      LoadingFields = 'Газета';
      Order = 'Газета.НазваниеОсн';
      Select;
      jj = Count;
      while not Eof do
        j = j + 1;
        vHint2 = (Current as РКП_Газеты.ПоступлениеГазеты).Газета.НазваниеОсн;
        vHint2 = ' : [ ' + Str(j) + ' / ' + Str(jj) + ' ] : ' + vHint2;
        Hint(vHint1 + vHint2 , aHint[2] as integer, aHint[3] as integer);
        aResult = РасчетПозиции_ПолучитьСтатистикуВыпускаЗаГод((Current as РКП_Газеты.ПоступлениеГазеты).Газета, Int(СодержаниеСтроки[vLine]));
        КолГазет[vLine]       = КолГазет[vLine]     + aResult[1] as Integer;
        КолНомеров[vLine]     = КолНомеров[vLine]   + aResult[2] as Integer;
        РазовыйТираж[vLine]   = РазовыйТираж[vLine] + aResult[3] as Numeric;
        ГодовойТираж[vLine]   = ГодовойТираж[vLine] + aResult[4] as Numeric;
        Next;
      od;
    end;
    if (КолГазет[vLine] > 0) then
      РазовыйТираж1[vLine] = Round(РазовыйТираж[vLine] / КолГазет[vLine], 1);
    fi;
  end;

  func РасчетПозиции_ФильтрПоступленийЗаГод(vLine :Integer) :String;
    var aCnd :String[];
    aCnd[1] = 'ГодПоступления=' + СодержаниеСтроки[vLine];
    aCnd[2] = 'НомеровПолучено>0';
    Return СложитьСтрокиФильтраПоИ(aCnd);
  end;

  func РасчетПозиции_ПолучитьСтатистикуПоступленийЗаГод (vFilter :String) :Variant[];
    with Query.Create([РКП_Газеты.ПоступлениеГазеты]) do
      Filter = vFilter;
      LoadingFields = "НомеровПолучено;ГодовойТираж;СреднийРазовыйТираж";
      Result = CalcAggregates('Count,Sum(НомеровПолучено),Sum(СреднийРазовыйТираж),Sum(ГодовойТираж)') as Variant[];
    end;
  end;



 --= OLD =--

--inobject
----------------------------------------------------------------------------------
--  proc ПостроитьОтчет(Sender :Button);
--  var Q        : query;
--  var k,j      : integer;
--  var QResult  : Variant[];
--  inherited ПостроитьОтчет(Sender);
--    for k = 1..15                       do
--       секцПозиции.InsertFrame(k);
--    end;
--    СодержаниеСтроки[01]="1940";    КолГазет[01]=5730;    КолНомеров[01]=604268;  РазовыйТираж[01]=25126;   ГодовойТираж[01]=5094619;         РазовыйТираж1[01]=4.4;
--    СодержаниеСтроки[02]="1950";    КолГазет[02]=5021;    КолНомеров[02]=543290;  РазовыйТираж[02]=25451;   ГодовойТираж[02]=5048429;         РазовыйТираж1[02]=5.1;
--    СодержаниеСтроки[03]="1960";    КолГазет[03]=4474;    КолНомеров[03]=585561;  РазовыйТираж[03]=45629;   ГодовойТираж[03]=11053327;        РазовыйТираж1[03]=10.2;
--    СодержаниеСтроки[04]="1970";    КолГазет[04]=4445;    КолНомеров[04]=568719;  РазовыйТираж[04]=93715;   ГодовойТираж[04]=22766660;        РазовыйТираж1[04]=21.1;
--    СодержаниеСтроки[05]="1980";    КолГазет[05]=4413;    КолНомеров[05]=502822;  РазовыйТираж[05]=119574;  ГодовойТираж[05]=29245100;        РазовыйТираж1[05]=27.1;
--    СодержаниеСтроки[06]="1990";    КолГазет[06]=4808;    КолНомеров[06]=523866;  РазовыйТираж[06]=165546;  ГодовойТираж[06]=3785263;         РазовыйТираж1[06]=34.4;
--    СодержаниеСтроки[07]="2000";    КолГазет[07]=5758;    КолНомеров[07]=377280;  РазовыйТираж[07]=108273;  ГодовойТираж[07]=7138919;         РазовыйТираж1[07]=18.8;
--    СодержаниеСтроки[08]="2001";    КолГазет[08]=5532;    КолНомеров[08]=341692;  РазовыйТираж[08]=100133;  ГодовойТираж[08]=5836530;         РазовыйТираж1[08]=18.1;
--    СодержаниеСтроки[09]="2002";    КолГазет[09]=6663;    КолНомеров[09]=322684;  РазовыйТираж[09]=128870;  ГодовойТираж[09]=6195774;         РазовыйТираж1[09]=19.3;
--    СодержаниеСтроки[10]="2003";    КолГазет[10]=8086;    КолНомеров[10]=387684;  РазовыйТираж[10]=214165;  ГодовойТираж[10]=10068231;        РазовыйТираж1[10]=26.5;
--    СодержаниеСтроки[11]="2004";    КолГазет[11]=7517;    КолНомеров[11]=310060;  РазовыйТираж[11]=177350;  ГодовойТираж[11]=7923043;         РазовыйТираж1[11]=23.6;
--    СодержаниеСтроки[12]="2005";    КолГазет[12]=7535;    КолНомеров[12]=327581;  РазовыйТираж[12]=177238;  ГодовойТираж[12]=7280618;         РазовыйТираж1[12]=23.5;
--    СодержаниеСтроки[13]="2006";    КолГазет[13]=8250;    КолНомеров[13]=327103;  РазовыйТираж[13]=192347;  ГодовойТираж[13]=8023919;         РазовыйТираж1[13]=23.3;
--    СодержаниеСтроки[14]="2007";    КолГазет[14]=8516;    КолНомеров[14]=337887;  РазовыйТираж[14]=203929;  ГодовойТираж[14]=7439902;         РазовыйТираж1[14]=23.9;
--    СодержаниеСтроки[15]="2008";    КолГазет[15]=8978;    КолНомеров[15]=368795;  РазовыйТираж[15]=211970.6;ГодовойТираж[15]=8214510.5;       РазовыйТираж1[15]=23.6;
--    k       = k-1;
--     --Расчет начиная с 2009 года включительно
--     for j = 2009..ЗаГод do
--       k                        = k+1;
--       секцПозиции.InsertFrame(k);
--       СодержаниеСтроки[k]      =Str(j);
--       QResult                  = nil;
--       Q                        = Query.Create([РКП_Газеты.ПоступлениеГазеты]);
--       Q.Filter                 = "ГодПоступления="+Str(j)+" and НомеровПолучено>0";
--       Q.LoadingFields          = "ГодовойТираж;НомеровПолучено;СреднийРазовыйТираж";
--       Q.Select;
--       QResult                  = Q.CalcAggregates("Count,Sum(НомеровПолучено),Sum(СреднийРазовыйТираж),Sum(ГодовойТираж)") as Variant[];
--       КолГазет[k]              = QResult[1];
--       КолНомеров[k]            = QResult[2];
--       РазовыйТираж[k]          = QResult[3];
--       ГодовойТираж[k]          = QResult[4];
--       if КолГазет[k]>0 then
--       РазовыйТираж1[k]         = Round(РазовыйТираж[k]/КолГазет[k],1);
--       end;
--       Q.Close;
--     end;
--    --Удаление строк, не содержащих значений
--    УдалитьПустыеСтроки;
--  end;


--  func ПолеЗаГодПриПроверке(Cell :TemplateCell; Index :Integer; var Value :Variant):Logical;
--    if Int(Value)<2008 then
--      Message('Допускается ввод значения >= 2008!');
--      Return false;
--    else
--      Return true;
--    end;
--  end;

--  proc ПолеЗаГодПриВыходе(Cell :TemplateCell; Index :Integer);
--  end;

  func CellOnClick(Cell :TemplateCell; Action :Template.ClickTypes) :Logical;
    ПостроитьОтчет(nil);
  end;

----}


end