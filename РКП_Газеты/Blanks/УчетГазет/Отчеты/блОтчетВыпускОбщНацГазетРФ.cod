class inherited РКП_Газеты.УчетГазет.Отчеты.блОтчетСтатРГБазовый2 "Выпуск всероссийских (общенациональных) газет в Российской Федерации";

import СИС2 classes СтроковыеФункции;

inobject private

--{{ 2_Свойства

  var РазовыйТираж1 :numeric[];
  const StartYear :Integer = 1940;
--}}

-- 2_Обработчики событий шаблона0. --

-- 2_Обработчики событий клеток шаблона0. --

  func ПолеЗаГодПриПроверке(Cell :TemplateCell; Index :Integer; var Value :Variant):Logical;
    if (Int(Value) < 2008) then
      Message('Допускается ввод значения >= 2008!');
      Return false;
    else
      Return true;
    fi;
  end;

-- 2_Обработчики событий прочих объектов шаблона0. --

  proc кнЭкспортПриНажатии(Sender :Button);
    try
    Template.CellByField['СодержаниеСтроки'].SetFocus;
    except 
    end;
    ExecuteCommand('Kernel.File.Export');
  end;

-- 2_Вспомогательные методы0. --

  proc 2_ПостроениеОтчета0.;
    ОтчетСоздан = Now;
    if (SessionInfo.UserRecord <> nil) then
      Библиограф = SessionInfo.UserRecord.FullName;
    fi;
    ОчиститьРезультатыРасчета;
    ПостроениеОтчета_АрхивныеДанные;
    ПостроениеОтчета_НовыеДанные;
    УдалитьПустыеСтроки;
  end;

  proc ОчиститьРезультатыРасчета;
    inherited ОчиститьРезультатыРасчета;
    РазовыйТираж1 = nil;
  end;

  proc ПостроениеОтчета_АрхивныеДанные; -- Данные за периоды 1940-2000 (шаг 10 лет) и 2001-2008 гг. - без изменений
    var vHeaderHint :string;
    var yy :integer;
    vHeaderHint = '1940 - 2008 гг. ';
    yy = (ЗаГод - StartYear);
    секцПозиции.FramesCount = 15;
    СодержаниеСтроки[01] = '1940'; КолГазет[01] = 46;  КолНомеров[01] = 7065;  РазовыйТираж[01] = 8769;    ГодовойТираж[01] = 2158340;   РазовыйТираж1[01] = 190.6;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[01] + ' / ' + Str(ЗаГод) + ' ]' , 1940 + 1 - StartYear, yy);
    СодержаниеСтроки[02] = '1950'; КолГазет[02] = 23;  КолНомеров[02] = 4663;  РазовыйТираж[02] = 9423;    ГодовойТираж[02] = 2311798;   РазовыйТираж1[02] = 409.7;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[02] + ' / ' + Str(ЗаГод) + ' ]' , 1950 + 1 - StartYear, yy);
    СодержаниеСтроки[03] = '1960'; КолГазет[03] = 25;  КолНомеров[03] = 5189;  РазовыйТираж[03] = 23524;   ГодовойТираж[03] = 6188914;   РазовыйТираж1[03] = 941.0;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[03] + ' / ' + Str(ЗаГод) + ' ]' , 1960 + 1 - StartYear, yy);
    СодержаниеСтроки[04] = '1970'; КолГазет[04] = 28;  КолНомеров[04] = 4874;  РазовыйТираж[04] = 62364;   ГодовойТираж[04] = 16232309;  РазовыйТираж1[04] = 2227.3; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[04] + ' / ' + Str(ЗаГод) + ' ]' , 1970 + 1 - StartYear, yy);
    СодержаниеСтроки[05] = '1980'; КолГазет[05] = 31;  КолНомеров[05] = 5095;  РазовыйТираж[05] = 80119;   ГодовойТираж[05] = 20799461;  РазовыйТираж1[05] = 2584.5; Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[05] + ' / ' + Str(ЗаГод) + ' ]' , 1980 + 1 - StartYear, yy);
    СодержаниеСтроки[06] = '1990'; КолГазет[06] = 43;  КолНомеров[06] = 5383;  РазовыйТираж[06] = 10810;   ГодовойТираж[06] = 27040247;  РазовыйТираж1[06] = 251.4;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[06] + ' / ' + Str(ЗаГод) + ' ]' , 1990 + 1 - StartYear, yy);
    СодержаниеСтроки[07] = '2000'; КолГазет[07] = 333; КолНомеров[07] = 14556; РазовыйТираж[07] = 39199;   ГодовойТираж[07] = 2034399;   РазовыйТираж1[07] = 117.7;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[07] + ' / ' + Str(ЗаГод) + ' ]' , 2000 + 1 - StartYear, yy);
    СодержаниеСтроки[08] = '2001'; КолГазет[08] = 238; КолНомеров[08] = 10402; РазовыйТираж[08] = 23040;   ГодовойТираж[08] = 1297724;   РазовыйТираж1[08] = 96.8;   Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[08] + ' / ' + Str(ЗаГод) + ' ]' , 2001 + 1 - StartYear, yy);
    СодержаниеСтроки[09] = '2002'; КолГазет[09] = 380; КолНомеров[09] = 14193; РазовыйТираж[09] = 39209;   ГодовойТираж[09] = 2124547;   РазовыйТираж1[09] = 103.2;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[09] + ' / ' + Str(ЗаГод) + ' ]' , 2002 + 1 - StartYear, yy);
    СодержаниеСтроки[10] = '2003'; КолГазет[10] = 405; КолНомеров[10] = 14750; РазовыйТираж[10] = 58673;   ГодовойТираж[10] = 2535178;   РазовыйТираж1[10] = 144.9;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[10] + ' / ' + Str(ЗаГод) + ' ]' , 2003 + 1 - StartYear, yy);
    СодержаниеСтроки[11] = '2004'; КолГазет[11] = 365; КолНомеров[11] = 12260; РазовыйТираж[11] = 32013;   ГодовойТираж[11] = 1661243;   РазовыйТираж1[11] = 87.7;   Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[11] + ' / ' + Str(ЗаГод) + ' ]' , 2004 + 1 - StartYear, yy);
    СодержаниеСтроки[12] = '2005'; КолГазет[12] = 373; КолНомеров[12] = 12404; РазовыйТираж[12] = 35371;   ГодовойТираж[12] = 1832340;   РазовыйТираж1[12] = 94.8;   Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[12] + ' / ' + Str(ЗаГод) + ' ]' , 2005 + 1 - StartYear, yy);
    СодержаниеСтроки[13] = '2006'; КолГазет[13] = 354; КолНомеров[13] = 12147; РазовыйТираж[13] = 34449;   ГодовойТираж[13] = 1774582;   РазовыйТираж1[13] = 97.3;   Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[13] + ' / ' + Str(ЗаГод) + ' ]' , 2006 + 1 - StartYear, yy);
    СодержаниеСтроки[14] = '2007'; КолГазет[14] = 352; КолНомеров[14] = 11793; РазовыйТираж[14] = 38121;   ГодовойТираж[14] = 1680713;   РазовыйТираж1[14] = 108.3;  Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[14] + ' / ' + Str(ЗаГод) + ' ]' , 2007 + 1 - StartYear, yy);
    СодержаниеСтроки[15] = '2008'; КолГазет[15] = 338; КолНомеров[15] = 12181; РазовыйТираж[15] = 31585.2; ГодовойТираж[15] = 1918633.1; РазовыйТираж1[15] = 93.4;   Hint(vHeaderHint + ' [ ' + СодержаниеСтроки[15] + ' / ' + Str(ЗаГод) + ' ]' , 2008 + 1 - StartYear, yy);
  end;

  proc ПостроениеОтчета_НовыеДанные; -- Данные за период начиная с 2009 года включительно
    var k, j, kk :integer;
    k = секцПозиции.FramesCount;
    kk = (ЗаГод - StartYear);
    for j = 2009 .. ЗаГод do
      k = k + 1;
      секцПозиции.InsertFrame(k);
      СодержаниеСтроки[k] = Str(j);
      if (ПравилоРасчетаСтатистики = Константы.статПравилоПоПоступлению) then
        РасчетПозиции_ПоступленияЗаПериод (k, [СодержаниеСтроки[k] + ' г. ', Int(СодержаниеСтроки[k]) + 1 - StartYear, kk]);
      else
        РасчетПозиции_ВыпускЗаПериод (k, [СодержаниеСтроки[k] + ' г. ', Int(СодержаниеСтроки[k]) + 1 - StartYear, kk]);
      fi;
    od;
  end;

  proc РасчетПозиции_ПоступленияЗаПериод (vLine :Integer; aHint :Variant[]);
    var vFlt :String;
    var aResult :Variant[];
    Hint(aHint[1] as string + ' [ ' + СодержаниеСтроки[vLine] + ' / ' + Str(ЗаГод) + ' ]' , aHint[2] as integer, aHint[3] as integer);
    vFlt = РасчетПозиции_ФильтрПоступленийЗаГод(vLine);
    aResult = РасчетПозиции_ПолучитьСтатистикуПоступленийЗаГод(vFlt);
    КолГазет[vLine]     = aResult[1];
    КолНомеров[vLine]   = aResult[2];
    РазовыйТираж[vLine] = aResult[3];
    ГодовойТираж[vLine] = aResult[4];
    if (КолГазет[vLine] > 0) then
      РазовыйТираж1[vLine] = Round(РазовыйТираж[vLine] / КолГазет[vLine], 1);
    fi;
  end;

  proc РасчетПозиции_ВыпускЗаПериод (vLine :Integer; aHint :Variant[]);
    var aResult :Variant[];
    var j, jj :integer;
    var vHint1, vHint2 :String;
    vHint1 = aHint[1] as string + ' [ ' + СодержаниеСтроки[vLine] + ' / ' + Str(ЗаГод) + ' ]';
    Hint(vHint1 + ' : Выполнение запроса...' , aHint[2] as integer, aHint[3] as integer);
    with Query.Create([РКП_Газеты.ПоступлениеГазеты]) do
      Filter = РасчетПозиции_ФильтрПоступленийЗаГод(vLine);
      LoadingFieldsMode = СИС2.Константы.mdNone;
      LoadingFields = 'Газета';
      Order = 'Газета.НазваниеОсн';
      Select;
      jj = Count;
      while not Eof do
        j = j + 1;
        vHint2 = (Current as РКП_Газеты.ПоступлениеГазеты).Газета.НазваниеОсн;
        vHint2 = ' : [ ' + Str(j) + ' / ' + Str(jj) + ' ] : ' + vHint2;
        Hint(vHint1 + vHint2 , aHint[2] as integer, aHint[3] as integer);
        aResult = РасчетПозиции_ПолучитьСтатистикуВыпускаЗаГод((Current as РКП_Газеты.ПоступлениеГазеты).Газета, Int(СодержаниеСтроки[vLine]));
        КолГазет[vLine]       = КолГазет[vLine]     + aResult[1] as Integer;
        КолНомеров[vLine]     = КолНомеров[vLine]   + aResult[2] as Integer;
        РазовыйТираж[vLine]   = РазовыйТираж[vLine] + aResult[3] as Numeric;
        ГодовойТираж[vLine]   = ГодовойТираж[vLine] + aResult[4] as Numeric;
        Next;
      od;
    end;
    if (КолГазет[vLine] > 0) then
      РазовыйТираж1[vLine] = Round(РазовыйТираж[vLine] / КолГазет[vLine], 1);
    fi;
  end;

  func РасчетПозиции_ФильтрПоступленийЗаГод(vLine :Integer) :String;
    var aCnd :String[];
    aCnd[1] = 'ГодПоступления=' + СодержаниеСтроки[vLine];
    aCnd[2] = 'НомеровПолучено>0';
    aCnd[3] = ФильтрОбщНацГазеты;
    Return СложитьСтрокиФильтраПоИ(aCnd);
  end;

  func ФильтрОбщНацГазеты :String; -- Вычисление фильтра на общенациональные газеты по территории распространения
    if (ФильтрОбщНацГазеты_ = nil) then
      with Query.Create([РКП_Справочники.СпрТерриторияРаспространения]) do
        Order = 'Номер';
        Select;
        while not Eof do
          if (Pos('ОБЩЕНАЦ', Up(Current.Наим)) > 0) then
            ФильтрОбщНацГазеты_ = 'ТерриторияРаспространения=' + Current.DocIdStr;
            Break;
          fi;
          Next;
        od;
      end;
    fi;
    Return ФильтрОбщНацГазеты_;
  end;

  var ФильтрОбщНацГазеты_ :String;

  func РасчетПозиции_ПолучитьСтатистикуПоступленийЗаГод (vFilter :String) :Variant[];
    with Query.Create([РКП_Газеты.ПоступлениеГазеты]) do
      Filter = vFilter;
      LoadingFields = "НомеровПолучено;ГодовойТираж;СреднийРазовыйТираж";
      Result = CalcAggregates('Count,Sum(НомеровПолучено),Sum(СреднийРазовыйТираж),Sum(ГодовойТираж)') as Variant[];
    end;
  end;

 --= OLD =--

--inobject
----РазовыйТираж1[]         : numeric;
----кнПостроить1            : Button;

----------------------------------------------------------------------------------
----{ Обработчики событий бланка

--  proc ПостроитьОтчет(Sender :Button);
--  var Q        : query;
--  var k,z,j    : integer;
--  var val      : string;
--  var QResult  : Variant[];
--  var Flt      : string;
--  Self.Template.EndEdit(True);
--  inherited ПостроитьОтчет(Sender);
--    for k = 1..15                       do
--       секцПозиции.InsertFrame(k);
--    end;
--    СодержаниеСтроки[01]="1940";    КолГазет[01]=46;     КолНомеров[01]=7065;   РазовыйТираж[01]=8769;   ГодовойТираж[01]=2158340;         РазовыйТираж1[01]=190.6;
--    СодержаниеСтроки[02]="1950";    КолГазет[02]=23;     КолНомеров[02]=4663;   РазовыйТираж[02]=9423;   ГодовойТираж[02]=2311798;         РазовыйТираж1[02]=409.7;
--    СодержаниеСтроки[03]="1960";    КолГазет[03]=25;     КолНомеров[03]=5189;   РазовыйТираж[03]=23524;  ГодовойТираж[03]=6188914;         РазовыйТираж1[03]=941.0;
--    СодержаниеСтроки[04]="1970";    КолГазет[04]=28;     КолНомеров[04]=4874;   РазовыйТираж[04]=62364;  ГодовойТираж[04]=16232309;        РазовыйТираж1[04]=2227.3;
--    СодержаниеСтроки[05]="1980";    КолГазет[05]=31;     КолНомеров[05]=5095;   РазовыйТираж[05]=80119;  ГодовойТираж[05]=20799461;        РазовыйТираж1[05]=2584.5;
--    СодержаниеСтроки[06]="1990";    КолГазет[06]=43;     КолНомеров[06]=5383;   РазовыйТираж[06]=10810;  ГодовойТираж[06]=27040247;        РазовыйТираж1[06]=251.4;
--    СодержаниеСтроки[07]="2000";    КолГазет[07]=333;    КолНомеров[07]=14556;  РазовыйТираж[07]=39199;  ГодовойТираж[07]=2034399;         РазовыйТираж1[07]=117.7;
--    СодержаниеСтроки[08]="2001";    КолГазет[08]=238;    КолНомеров[08]=10402;  РазовыйТираж[08]=23040;  ГодовойТираж[08]=1297724;         РазовыйТираж1[08]=96.8;
--    СодержаниеСтроки[09]="2002";    КолГазет[09]=380;    КолНомеров[09]=14193;  РазовыйТираж[09]=39209;  ГодовойТираж[09]=2124547;         РазовыйТираж1[09]=103.2;
--    СодержаниеСтроки[10]="2003";    КолГазет[10]=405;    КолНомеров[10]=14750;  РазовыйТираж[10]=58673;  ГодовойТираж[10]=2535178;         РазовыйТираж1[10]=144.9;
--    СодержаниеСтроки[11]="2004";    КолГазет[11]=365;    КолНомеров[11]=12260;  РазовыйТираж[11]=32013;  ГодовойТираж[11]=1661243;         РазовыйТираж1[11]=87.7;
--    СодержаниеСтроки[12]="2005";    КолГазет[12]=373;    КолНомеров[12]=12404;  РазовыйТираж[12]=35371;  ГодовойТираж[12]=1832340;         РазовыйТираж1[12]=94.8;
--    СодержаниеСтроки[13]="2006";    КолГазет[13]=354;    КолНомеров[13]=12147;  РазовыйТираж[13]=34449;  ГодовойТираж[13]=1774582;         РазовыйТираж1[13]=97.3;
--    СодержаниеСтроки[14]="2007";    КолГазет[14]=352;    КолНомеров[14]=11793;  РазовыйТираж[14]=38121;  ГодовойТираж[14]=1680713;         РазовыйТираж1[14]=108.3;
--    СодержаниеСтроки[15]="2008";    КолГазет[15]=338;    КолНомеров[15]=12181;  РазовыйТираж[15]=31585.2;ГодовойТираж[15]=1918633.1;       РазовыйТираж1[15]=93.4;
--    k       = k-1;
--    --поиск ключа общенациональных газет
--      Q                         = Query.Create([РКП_Справочники.СпрТерриторияРаспространения]);
--      Q.Select;
--      Q.First;
--      for z =  1..Q.Count               do
--        val     = Q.Current.Наим;
--        if Pos('ОБЩЕНАЦ',Up(val))>0     then
--          Flt   ="ТерриторияРаспространения="+Str(Q.Current);
--          Break;
--        end;
--        Q.Next;
--      end;
--      Q.Close;
--     --Расчет начиная с 2009 года включительно
--     for j = 2009..ЗаГод do
--       k                        = k+1;
--       секцПозиции.InsertFrame(k);
--       СодержаниеСтроки[k]      =Str(j);
--       QResult                  = nil;
--       Q                        = Query.Create([РКП_Газеты.ПоступлениеГазеты]);
--       Q.Filter                 = "ГодПоступления="+Str(j)+" and НомеровПолучено>0"+" and "+Flt;
--       Q.LoadingFields          = "ГодовойТираж;НомеровПолучено;СреднийРазовыйТираж";
--       Q.Select;
--       QResult                  = Q.CalcAggregates("Count,Sum(НомеровПолучено),Sum(СреднийРазовыйТираж),Sum(ГодовойТираж)") as Variant[];
--       КолГазет[k]              = QResult[1];
--       КолНомеров[k]            = QResult[2];
--       РазовыйТираж[k]          = QResult[3];
--       ГодовойТираж[k]          = QResult[4];
--       if КолГазет[k]>0 then
--       РазовыйТираж1[k]         = Round(РазовыйТираж[k]/КолГазет[k],1);
--       end;
--       Q.Close;
--     end;
--    --Удаление строк, не содержащих значений
--    УдалитьПустыеСтроки;
--  end;






----  func ПолеЗаГодПриПроверке(Cell :TemplateCell; Index :Integer; var Value :Variant):Logical;
----    if Int(Value)<2008 then
----      Message('Допускается ввод значения >= 2008!');
----      Return false;
----    else
----      Return true;
----    end;
----  end;

--  proc ПолеЗаГодПриВыходе(Cell :TemplateCell; Index :Integer);
--  end;

  func CellOnClick(Cell :TemplateCell; Action :Template.ClickTypes) :Logical;
    ПостроитьОтчет(nil);
  end;

----}


end