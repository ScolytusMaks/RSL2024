class  inherited СИС2.БазовыйБланкРедактор "", editor ВыпускЛППИ;

inclass

inobject
  ПапкаЛППИ             : string = "C:\МАКЕТ\ЛППИ\"+Str(ГодЛетописи);
  ФайлЛППИ              : string = "C:\МАКЕТ\ЛППИ\"+Str(ГодЛетописи)+
                                   "\ЛППИ.txt";
  --
  var Раздел_УТ         : logical[];
  var Тематика_УТ       : string[];
  var Газета_УТ         : string[];
  var НомерЗаписи_УТ    : string[];
  секцУказательТематик  : TemplateSection;


--------------------------------------------------------------------------------
--{ Обработчики событий бланка
 proc ПодготовкаСистУказателя;
    var k,i,g,m                 : integer;
    var Qs,Qg                   : Query;
    var НазваниеОсн             : string;
    var МестоИздания            : string;
    var МестоИзданияБибл        : string;
    var ПлюсМестоИздания        : string;
    var ЯзыкИздания             : string;
    var ПлюсЯзыкИздания         : string;
      Раздел_УТ                 = nil;
      Тематика_УТ               = nil;
      Газета_УТ                 = nil;
      НомерЗаписи_УТ            = nil;
      секцУказательТематик.Count= 0;
      Qs                        = Query.Create([РКП_Справочники.СпрТематика]);
      Qs.Order                  = "Код";
      Qs.Select;
      Qs.First;
      for k = 1..Qs.Count       do      
        Hint("Систематический указатель ("+Qs.Current.Наим+")",k,Qs.Count);
        Qg                      = Query.Create([РКП_Газеты.Газета]);
        Qg.Filter               = "ГодЛетописи="+Str(ГодЛетописи)+
                                  --" and ПризнакОтсылки=false"+  --13.01.2009
                                  " and "+"("+
                                  "Тематики.Exists(Тематика.DocID="+Str(Qs.Current.DocID)+")"+
                                  " or "+
                                  "ЧАЦН.Exists(ЧАЦН.DocID="+Str(Qs.Current.DocID)+")"+
                                  ")";
        Qg.Order                = "ЗаписьВЛетописи";
        Qg.Select;
        if Qg.Count>0           then
          --1.добавить строку с названием тематики и метку - что это раздел
          i                     = i+1;
          Раздел_УТ[i]          = true;
          Тематика_УТ[i]        = Qs.Current.Наим;
          --2.в цикле по записям Qg добавить строки с урезанным описанием и номером статьи
          Qg.First;
          for g = 1..Qg.Count   do
            i                   =  i+1;
            Тематика_УТ[i]      = Qs.Current.Наим;
            if Qg.Current.ПризнакОтсылки=false                          then
              НазваниеОсн       = Qg.Current.НазваниеОсн;
            else
              if Qg.Current.Отсылка<>nil                                then
              НазваниеОсн       = Qg.Current.НазваниеОсн;
              НазваниеОсн       = SubStr(НазваниеОсн,1,Pos('. - ',НазваниеОсн)-1);
              end;
            end;

            ПлюсМестоИздания    = "";
            МестоИздания        = "";
            ПлюсЯзыкИздания     = "";
            ЯзыкИздания         = "";
            if Qg.Current.МестаИздания.Count>0                          then
              for m = 1..Qg.Current.МестаИздания.Count                  do
                МестоИздания    = Qg.Current.МестаИздания.Items[m].МестоИздания.Наим;
                --МестоИзданияБибл= Qg.Current.МестаИздания.Items[m].МестоИздания.НаимБибл;
                МестоИзданияБибл= Qg.Current.МестаИздания.Items[m].МестоИздания.НаимСокр;
                if Pos(SubStr(МестоИздания,1,4),НазваниеОсн)>0          then
                  МестоИздания  = "";
                fi;
                if МестоИздания<>""                                     then
                  if ПлюсМестоИздания=""                                then
                    if МестоИзданияБибл<>""                             then
                      ПлюсМестоИздания          = МестоИзданияБибл;
                    else
                      ПлюсМестоИздания          = МестоИздания;
                    end;
                  else
                    if МестоИзданияБибл<>""                             then
                      ПлюсМестоИздания          = ПлюсМестоИздания+" ; "+МестоИзданияБибл;
                    else
                      ПлюсМестоИздания          = ПлюсМестоИздания+" ; "+МестоИздания;
                    end;
                  end;
                end;
              end;
            end;
            --ЯзыкиИздания
            if Qg.Current.Языки.Count>0                                 then
              for m = 1..Qg.Current.Языки.Count                         do
                if m=1                                                  then
                  if  Qg.Current.Языки.Items[m].Язык.ГосЯзРФ=false      then
                    ЯзыкИздания         = Qg.Current.Языки.Items[m].Язык.НаимБибл;
                    ЯзыкИздания         = Lo(ЯзыкИздания);
                  end;
                else
                    ЯзыкИздания         = Qg.Current.Языки.Items[m].Язык.НаимБибл;
                    ЯзыкИздания         = Lo(ЯзыкИздания);
                end;
                if ПлюсЯзыкИздания=""                                   then
                  ПлюсЯзыкИздания       = ЯзыкИздания;
                    ЯзыкИздания         = Lo(ЯзыкИздания);
                else
                  ПлюсЯзыкИздания       = ПлюсЯзыкИздания+", "+ЯзыкИздания;
                fi;
              end;
            end;
            if ПлюсМестоИздания<>""                                     then
              НазваниеОсн               = НазваниеОсн+". "+ПлюсМестоИздания;
            end;
            if ПлюсЯзыкИздания<>""                                      then
              НазваниеОсн               = НазваниеОсн+" ("+ПлюсЯзыкИздания+")";
            end;
            Газета_УТ[i]                = НазваниеОсн;
            if Qg.Current.ПризнакОтсылки=false                          then
            НомерЗаписи_УТ[i]           = Str(Qg.Current.НомерВЛетописи);
            else
              if Qg.Current.Отсылка<>nil                                then
            НомерЗаписи_УТ[i]           = Str(Qg.Current.Отсылка.НомерВЛетописи);
              end;
            end;

            Qg.Next;
          end;
        end;
        Qs.Next;
      end;
      Qs.Close;
      секцУказательТематик.Count= i;
 end;

  proc СозданиеСистУказателя;
    var p       : integer;
    var k       : integer;
    var ЛППИ    : TextFile;
    ПодготовкаСистУказателя;
    -------
    if    ExistFolder(ПапкаЛППИ) = false                        then
      CreateFolder(ПапкаЛППИ);
    end;
    if  ExistFile(ПапкаЛППИ+"\СистУказатель.txt") = true        then
      RemoveFile(ПапкаЛППИ+"\СистУказатель.txt");
    end;
    ЛППИ        = TextFile.Create(ПапкаЛППИ+"\СистУказатель.txt",fmCreate);
    ------
    ЛППИ.WriteLn("");
    ЛППИ.WriteLn("ВСПОМОГАТЕЛЬНЫЕ УКАЗАТЕЛИ");
    ЛППИ.WriteLn("СИСТЕМАТИЧЕСКИЙ УКАЗАТЕЛЬ НАЗВАНИЙ ГАЗЕТ");
    ЛППИ.WriteLn("");
    for k=1..секцУказательТематик.Count                         do
      Hint("Формирование файла...",k,секцУказательТематик.Count);
      if Раздел_УТ[k]=true                                      then
        ЛППИ.WriteLn("");
        ЛППИ.WriteLn("/*"+Тематика_УТ[k]+"*/");
        ЛППИ.WriteLn("");
      else
        p       = Pos('=',Газета_УТ[k]);
        if p=0                  then
        ЛППИ.WriteLn("    "+Газета_УТ[k]+" "+НомерЗаписи_УТ[k]);
        else
        ЛППИ.WriteLn("    "+SubStr(Газета_УТ[k],1,p-2)+" "+НомерЗаписи_УТ[k]);
        end;
      end;
    end;
    end;


--}

end