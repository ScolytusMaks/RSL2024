class inherited СИС2.БазовыйБланкРедактор "Отчет о пополнении БД", editor СправкаКолЕдиницХранения;

inobject private

--{{ _Свойства
  var секцШапка     :Section;
  var секцПозиции   :Section;
  var секцПозиции_  :Section;
  var секцСПО       :Section;
  var секцВарианты  :Section;
  var CheckBox1     :CheckBox;
  var клЗаДату1     :TemplateCell := секцВарианты.CellByField['ЗаДату1'];
  var клЗаДату2     :TemplateCell := секцВарианты.CellByField['ЗаДату2'];
  var клЗаДату3     :TemplateCell := секцВарианты.CellByField['ЗаДату3'];
  var клЗаДату4     :TemplateCell := секцВарианты.CellByField['ЗаДату4'];
  var клЗаДату5     :TemplateCell := секцВарианты.CellByField['ЗаДату5'];
  var Газета_       :РКП_Газеты.Газета[];
  var NomGazet_     :String[];
  var KolGazet_     :Integer[];
  var Nom           :Integer[];
--}}

-- _Конструкторы, визуализаторы. --

inclass public

inobject private

-- _Обработчики событий шаблона. --



-- _Обработчики событий клеток шаблона. --

  func СменаВариантаПериода(Cell :TemplateCell; Action :Template.ClickTypes) :Logical; -- ПриНажатии
    if (ЗаГод > 1801) and (ЗаГод < 2999) then
      УстНачальноеСостояниеФормы;
      if (Cell = клЗаДату1) then
        ЗаДату        = 0;
        ЗаДату1       = true;
        ДатаН         = РКП_СИС.СтандартныйПериод.НачалоГода(Today);
        ДатаК         = Today;
        ПериодЗапроса = 'в I квартале ' + Str(ЗаГод) + ' г.';
        клЗаДату1.Font.Bold = true;
        ОчиститьРезультатыРасчета;
      elsif (Cell = клЗаДату2) then
        ЗаДату        = 1;
        ЗаДату2       = true;
        ДатаН         = РКП_СИС.СтандартныйПериод.НачалоМесяца(Today);
        ДатаК         = Today;
        ПериодЗапроса = 'в I-II квартале ' + Str(ЗаГод) + ' г.';
        клЗаДату2.Font.Bold = true;
        ОчиститьРезультатыРасчета;
      elsif (Cell = клЗаДату3) then
        ЗаДату        = 2;
        ЗаДату3       = true;
        ДатаН         = РКП_СИС.СтандартныйПериод.НачалоКвартала(Today);
        ДатаК         = Today;
        ПериодЗапроса = 'в I-III квартале ' + Str(ЗаГод) + ' г.';
        клЗаДату3.Font.Bold = true;
        ОчиститьРезультатыРасчета;
      elsif (Cell = клЗаДату4) then
        ЗаДату        = 3;
        ЗаДату4       = true;
        ДатаН         = РКП_СИС.СтандартныйПериод.НачалоГода(Today);
        ДатаК         = Today;
        ПериодЗапроса = 'в ' + Str(ЗаГод) + ' г.';
        клЗаДату4.Font.Bold = true;
        ОчиститьРезультатыРасчета;
      elsif (Cell = клЗаДату5) then
        ЗаДату        = 4;
        ЗаДату5       = true;
        ДатаН         = Dat(Day(ДатаН), Mon(ДатаН), ЗаГод);
        ДатаК         = Dat(Day(ДатаК), Mon(ДатаК), ЗаГод);
        ПериодЗапроса = 'с ' + Str(ДатаН) + ' по ' + Str(ДатаК);
        клЗаДату5.Font.Bold = true;
        секцСПО.Visible   = true;
        ОчиститьРезультатыРасчета;
      fi;
    else
      Message('Пожалуста, укажите корректный год запроса!');
    fi;
  end;

  proc УстНачальноеСостояниеФормы;
    ЗаДату1 = false;
    ЗаДату2 = false;
    ЗаДату3 = false;
    ЗаДату4 = false;
    ЗаДату5 = false;
    ЗаДату  = nil;
    секцСПО.Visible = false;
    секцВарианты.CellByField['ЗаДату1'].Font.Bold = false;
    секцВарианты.CellByField['ЗаДату2'].Font.Bold = false;
    секцВарианты.CellByField['ЗаДату3'].Font.Bold = false;
    секцВарианты.CellByField['ЗаДату4'].Font.Bold = false;
    секцВарианты.CellByField['ЗаДату5'].Font.Bold = false;
  end;

  proc ОчиститьРезультатыРасчета;
      Газета_                                   = nil;
      секцПозиции_.Count                        = nil;
      ВсегоЕдиницХранения                       = nil;
      ВсегоЕдиницИзданий                        = nil;
      Record.Позиции.Clear;
      nomgazet_                                 = nil;
      kolgazet_                                 = nil;
  end;

--------------------------------------------------------------------------------
--{ Обработчики событий бланка

  func ПолеГодПриОбзоре(Cell :TemplateCell; Value :Variant; var NewValue :Variant) :Logical;
    var vYear :Integer;
    if (CmOk = РКП_СИС.Сервис.блВыборГода.ВыполнитьВыбор(vYear)) then
      NewValue     = vYear;
      ЗаГод        = NewValue;
      Template.EndEdit(True);
      if          ЗаДату = 0      then
        Result = СменаВариантаПериода(секцВарианты.CellByField["ЗаДату1"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 1      then
        Result = СменаВариантаПериода(секцВарианты.CellByField["ЗаДату2"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 2      then
        Result = СменаВариантаПериода(секцВарианты.CellByField["ЗаДату3"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 3      then
        Result = СменаВариантаПериода(секцВарианты.CellByField["ЗаДату4"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 4      then
        Result = СменаВариантаПериода(секцВарианты.CellByField["ЗаДату5"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      else
        Result = false;
      end;
    else
      Result = false;
    end;
  end;

  proc ПолеЗаГодПриВыходе(Cell :TemplateCell; Index :Integer);
      if          ЗаДату = 0      then
        СменаВариантаПериода(секцВарианты.CellByField["ЗаДату1"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 1      then
        СменаВариантаПериода(секцВарианты.CellByField["ЗаДату2"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 2      then
        СменаВариантаПериода(секцВарианты.CellByField["ЗаДату3"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 3      then
        СменаВариантаПериода(секцВарианты.CellByField["ЗаДату4"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      elsif       ЗаДату = 4      then
        СменаВариантаПериода(секцВарианты.CellByField["ЗаДату5"],Template.ClickTypes(1));
        ОчиститьРезультатыРасчета;
      end;
  end;




  proc ПостроитьОтчет(Sender :Button);
    var rec             : record;
    var Q               : query;
    var k,z             : integer;
    var val_0,val_1     : record;
    var nomgazet        : string;
    var kolgazet        : integer;
      if (Record.State = Record.Edited)                 or
         (Record.State = Record.Created)                then
        Record.Post;
      end;
    rec                                         = SessionInfo.UserRecord;
    if rec <>nil                                        then
      Библиограф                                = rec.FullName;
    end;
    if    ДатаН<>nil                                    and     --проверка корректности условий
          ДатаК<>nil                                    and
          ДатаН<=ДатаК                                  then
      ОчиститьРезультатыРасчета;
      --анализ номеров
      --построение списка газет, для которых вводились номера
      Hint("Открытие запроса к БД...");
      Q                         = Query.Create([РКП_Газеты.НомерГазеты]);
      Q.Filter                  = "ФункцияГруппы=0"+
                                  " and ДатаПринятияНаХранение>="+Str(ДатаН)+
                                  " and ДатаПринятияНаХранение<"+Str(ДатаК+1)+
                                  " and ПринялНаХранение<>'Администратор'";
      Q.LoadingFields           = "Газета;Номер";
      --Q.Order                   = "Газета;Газета.НазваниеОсн;Газета.DocId";
      Q.Order                   = "Газета;Номер";
      Q.Select;
      --Q.First;
      for k =  1..Q.Count               do
      Hint("Анализ номеров газет...",k,Q.Count);
        val_1                   = Q.Current.Газета;
          if val_1<>val_0               or 
             k=1                        then
            z                   = z+1;
            ВсегоЕдиницИзданий  = z;
            секцПозиции_.InsertFrame(z);
            InsertInArray(Газета_,z,Q.Current.Газета);
            if k=1 then
             nomgazet = trim(str(Q.Current.Номер))+';';
             kolgazet = 1;
            else
             nomgazet = '';
             kolgazet = 0;
            end;
          end;
        val_0                   = Q.Current.Газета;
        if k<>1 then
         nomgazet = nomgazet + trim(str(Q.Current.Номер))+ ';';
         kolgazet = kolgazet + 1;
         InsertInArray(nomgazet_,z,nomgazet);
         InsertInArray(kolgazet_,z,kolgazet);
        end;
        Q.Next;
      end;
      Hint("Закрытие запроса к БД...");
      Q.Close;
      --расчет--12.01.2009
      ВсегоЕдиницХранения                       = РКП_Газеты.Стат.ПринятоНомеровВсегоЗаПериод(ДатаН,ДатаК);
      if  CmOk=EnqOkCancel("Построить список газет?")           then
      for k =  1..секцПозиции_.Count    do
        Hint("Расчет газеты <"+Газета_[k].НазваниеОсн+">",k,секцПозиции_.Count);
        Record.Позиции.Add;
        Record.Позиции[k].Издание               = Газета_[k].НазваниеОсн;
        Record.Позиции[k].НомераГазет           = NomGazet_[k];
        Record.Позиции[k].КолГазет              = KolGazet_[k];
        Nom[k]                                  = k;
      end;
      end;
    else
      Message("Неверно заданы даты построения отчета!");
    end;                                        --проверка корректности условий
  end;


  proc шаблон_ПриЗакрытии(Destroy :Logical);
    inherited шаблон_ПриЗакрытии(Destroy);
    --self.SaveClass(ИмяФайлаdbt);
  end;


  proc шаблон_ПриСчитывании;
  var k : integer;
    inherited шаблон_ПриСчитывании;
    if Record.State             =  Record.Created then
      СменаВариантаПериода(секцВарианты.CellByField["ЗаДату5"],Template.SingleClick);
    end;
    for k =  1..секцПозиции.Count    do
      Nom[k]                                  = k;
    end;
  end;



  proc ОписатьПериодЗапроса(Cell :TemplateCell; Index :Integer);
       ПериодЗапроса            = "с "+str(ДатаН)+" по "+str(ДатаК);
  end;



  func FieldNomOnOutput(Cell :TemplateCell; Value :Variant;Action :Template.OutputTypes; var Format :String) :Variant;
    Result = Slo(Value+1);
  end;

  proc CheckBox1OnChange(Sender :CheckBox);
    if sender.state then
      секцШапка.column[4].visible = true;
      секцПозиции.column[4].visible = true;
    else
      секцШапка.column[4].visible = false;
      секцПозиции.column[4].visible = false;
    end;
  end;

  proc BlankOnOpen(Create :Logical);
    -- Вызывается при открытия окна формы
    --   Create: True - форма открывается, False - форма восстанавливается при запуске сессии
  CheckBox1.state = true;
  end;

--}

end