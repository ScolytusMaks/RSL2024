class "";

Import РКП_СИС Classes StdCode, DateDescription;
Import РКП_Газеты Classes Стат;

inclass public

--#################################################################################
  func Создание(Газета :Газета; var Заголовок, ОписаниеГазеты :String) :Integer; -- возврат CmOk при положительном завершении
    if (Газета.ГодЛетописи > 0) then
      if (not Газета.ИсправленоБиблиографом) then
        if (Газета.Отсылка = nil) and (Газета.ПризнакОтсылки) then
          Trace('Пожалуйста, укажите газету отсылки для "' + Газета.НазваниеОсн +'"!');
          Return -1;
        fi;
        if (Газета.МестаИздания.Count = 0) then
          Trace('Пожалуйста, укажите место издания газеты для "' + Газета.НазваниеОсн + '"!');
          Return -2;
        fi;
        -- предварительная проверка закончена
        Заголовок = ФормированиеЗаголовка(Газета);
        if (Газета.ПризнакОтсылки) then
          ОписаниеГазеты = ФормированиеОписанияОтсылки(Газета);
        elsif (not Газета.ПризнакОтсылки) then
          ОписаниеГазеты = ФормированиеОписанияГазеты(Газета);
        fi;
        Return CmOk;
      fi;
    fi;
  end;
--#################################################################################



--/////////////////////////////////////////////////////////////////////////////////
  func ФормированиеЗаголовка(Газета:Газета):string;
    var ps      : integer[];
   if    Газета.ПризнакОтсылки = true                                   then
    --определение позиции замыкающего знака пунктуации (".!?")
     ps[1]      = if(Pos('. - ',Trim(Газета.НазваниеОсн))>0,Pos('. - ',Trim(Газета.НазваниеОсн)),1000);
     ps[2]      = if(Pos('! - ',Trim(Газета.НазваниеОсн))>0,Pos('! - ',Trim(Газета.НазваниеОсн)),1000);
     ps[3]      = if(Pos('? - ',Trim(Газета.НазваниеОсн))>0,Pos('? - ',Trim(Газета.НазваниеОсн)),1000);
    --выделение основного названия
     Result     = SubStr(Trim(Газета.НазваниеОсн),1,Min(ps)2-10);
   elsif Газета.ПризнакОтсылки = false                                  then
     Result       = Trim(Газета.НазваниеОсн);
   end;
   Return Result;
  end;

--/////////////////////////////////////////////////////////////////////////////////
  func ФормированиеОписанияГазеты(Газета:Газета):string;
  var RecEnd           : record;
  var i,k              : integer;
  var Q,Q2,Q3          : Query;
  var Периодичность    : string;
  var ЧислоПолос       : string;
  var ОписаниеЯзыка    : string;
  var Серия_От         : integer;
  var Серия_До         : integer;
  var Серий            : integer;
  var Серия            : integer;
  var ПериодСерии      : string;
  var номер_0          : string;
  var номер_1          : string;
  var номер_2          : string;
  var номера           : string;
  var ВаловыйНомер     : string;
  var QResult          : variant[];
  var тираж            : string;
  var RLast            : record;

    --Подзаголовок--
    if Газета.Подзаголовок<>nil                                         then  -- при наличии подзаголовка
                Result = " : "+Trim(Газета.Подзаголовок);
    end;
    --Учредители--
    if Газета.Учред <> nil                                              then  -- при наличии учредителей
      if    Газета.ГруппаУчредителей = false                            then
                Result  = Result+" / учредитель "+Trim(Газета.Учредитель);
      elsif Газета.ГруппаУчредителей = true                             then
                Result  = Result+" / учредители: "+Trim(Газета.Учредители);
      end;
    end;
    --ликвидация первой замыкающей точки
    if SubStr(Result,Length(Result),1)='.'                              then
                Result  = SubStr(Result,1,Length(Result)-1);
    end;
    --ликвидация вторй замыкающей точки
    if SubStr(Result,Length(Result),1)='.'                              then
                Result  = SubStr(Result,1,Length(Result)-1);
    end;
    --Начало и (если прекращено) прекращение--
    if     Газета.Прекращено = false                                    then -- НЕ прекращенное издание (1)
                --Result  = Result+". - ";
      if НомеровПолучено(Газета,Year(Газета.ДатаВыходаПервогоНомера))>0 then
      if    Газета.ТочностьДатыПервогоНомера = 0                        then
                Result  = Result+". - "+ВСтроку(Газета.ДатаВыходаПервогоНомера, dfYYYYDDMMM);
      elsif Газета.ТочностьДатыПервогоНомера = 1                        then
                Result  = Result+". - "+ВСтроку(Газета.ДатаВыходаПервогоНомера, dfYYYYMMM);
      elsif Газета.ТочностьДатыПервогоНомера = 2                        then
                Result  = Result+". - "+ВСтроку(Газета.ДатаВыходаПервогоНомера, dfYYYY);
      end;--Газета.ТочностьДатыПервогоНомера
      else--НомеровПолучено=0
--        if Int(ВСтроку(Газета.ДатаВыходаПервогоНомера,dfYYYY))=Газета.ГодЛетописи           or
--           Int(ВСтроку(Газета.ДатаВыходаПервогоНомера,dfYYYY))=Газета.ГодЛетописи-1         then
                Result  = Result+". - "+'['+ВСтроку(Газета.ДатаВыходаПервогоНомера, dfYYYY)+']';
--        end;
      end;
                Result  = Result+" -    . - ";
     elsif Газета.Прекращено = true                                     then -- ПРЕКРАЩЕННОЕ издание (1)
       RecEnd           =  НомерПрекращения(Газета);
       if RecEnd= nil                                                   then
         Trace("Программа не может найти описание номера прекращения газеты <"+Газета.НазваниеОсн+">. Пожалуйста, взведите флаг <Прекращение издания> в номере, на котором издание прекратилось!");
         Return "";
       elsif RecEnd<>nil                                                then
         if    RecEnd.ГодВыпуска<>Year(Газета.ДатаВыходаПервогоНомера)  then --год прекращения газеты НЕ равен году начала издания
                Result  = Result+". - ";
           if    Газета.ТочностьДатыПервогоНомера = 0                   then
                Result  = Result+ВСтроку(Газета.ДатаВыходаПервогоНомера,dfYYYYDDMMM);
           elsif Газета.ТочностьДатыПервогоНомера = 1                   then
                Result  = Result+ВСтроку(Газета.ДатаВыходаПервогоНомера,dfYYYYMMM);
           elsif Газета.ТочностьДатыПервогоНомера = 2                   then
                Result  = Result+ВСтроку(Газета.ДатаВыходаПервогоНомера,dfYYYY);
           end;--Газета.ТочностьДатыПервогоНомера
           if    Газета.ТочностьДатыПервогоНомера = 2                   then
                Result  = Result+"-";
           else
                Result  = Result+" - ";
           end;
                --Result  = Result+" - ";
           if    RecEnd.ТочностьДатыВыхода = 0                          then
                Result  = Result+ВСтроку(RecEnd.ДатаВыхода,dfYYYYDDMMM);
                Result  = Result+" - ";
           elsif RecEnd.ТочностьДатыВыхода = 1  then
                Result  = Result+ВСтроку(RecEnd.ДатаВыхода,dfYYYYMMM);
                if SubStr(Result,Length(Result),1)<>'.'                 then
                Result  = Result+".";
                end;
                Result  = Result+" - ";
           elsif RecEnd.ТочностьДатыВыхода = 2                          then
                Result  = Result+ВСтроку(RecEnd.ДатаВыхода,dfYYYY);
                Result  = Result+". - ";
           end;--RecEnd.ТочностьДатыВыхода (последнего номера)
         elsif RecEnd.ГодВыпуска=Year(Газета.ДатаВыходаПервогоНомера)   then --год прекращения газеты РАВЕН году начала издания
                Result  = Result+" - ";
                Result  = Result+Str(RecEnd.ГодВыпуска);
                Result  = Result+". - ";
         end;--RecEnd.ГодВыпуска<>Year(...
       end;--RecEnd= nil
    end;--Газета.Прекращено
    --Место издания--
    for i = 1..Газета.МестаИздания.Count                                do
      if i>1                                                            then
                Result  = Result+" ; ";
      end;
      if    Газета.МестаИздания.Items[i].МестоИздания.НаимБибл<>nil     then
                Result  = Result+Газета.МестаИздания.Items[i].МестоИздания.НаимБибл;
      elsif Газета.МестаИздания.Items[i].МестоИздания.НаимБибл=nil      then
                Result  = Result+Газета.МестаИздания.Items[i].МестоИздания.Наим;
      end;
    end;--for i=...
                Result  = Result+", ";
                RLast=ПоследнийПолученныйНомер(Газета);
                if RLast<>nil                                           then
                if ПоследнийПолученныйНомер(Газета).ГодВыпуска<>nil     then
                Result  = Result+Str(ПоследнийПолученныйНомер(Газета).ГодВыпуска);
                end;
                end;
    --Число полос, периодичность - вычисление
    Q                   = Query.Create([РКП_Газеты.ВыпускГазеты]);
    Q.Filter            = 'Газета='+Str(Газета);
    Q.Order             = "ГодВыпуска";
    Q.Select;
      if Q.Count>0                                                      then
        Q.Last;
        --Периодичность   = Q.Current.Периодичность;
        if    Q.Current.Газета.КатегорияПериодичности=4 and Q.Current.Газета.КоличествоВПериоде=12 then
          Периодичность   = 'Ежемес.';
        elsif Q.Current.Газета.КатегорияПериодичности=1 and Q.Current.Газета.КоличествоВПериоде=3  then
        else
          Периодичность   = Q.Current.Газета.Периодичность;
        end;
        ЧислоПолос      = Q.Current.ЧислоПолос;
      end;--Q.Count>0
    Q.Close;
    --Число полос, периодичность - описание
        if    Газета.Прекращено=false                                   then -- НЕ прекращенное издание (2)
                Result  = Result+" -    . - ";
        elsif Газета.Прекращено=true                                    then -- ПРЕКРАЩЕННОЕ издание (2)
                Result  = Result+". - ";
        end;--Газета.Прекращено
                Result  = Result+ЧислоПолос+" п."+Chr(13);
        if  Периодичность<>"Неопределенно"                              then
                Result  = Result+Периодичность;
          if SubStr(Result,Length(Result),1)<>"."                       then
                Result  = Result+".";
          end;
        end;--Периодичность<>"Неопределенно"
        --языки - вычисление
        if Газета.Языки.Count>0                                         then    --если указан язык издания газеты
          if Газета.Языки.Items[1].Язык.ГосЯзРФ=false                   then    -- если указанный язык не является государственным языком РФ
            for i=1..Газета.Языки.Count                                 do
              if i=1                                                    then
                ОписаниеЯзыка   = Газета.Языки.Items[i].Язык.НаимБибл;          -- то считывается сокращенное библиографическое наименование языка
              else
                --ОписаниеЯзыка   = ОписаниеЯзыка+" ; "+Газета.Языки.Items[i].Язык.НаимБибл;  -- то считывается сокращенное библиографическое наименование языка
                ОписаниеЯзыка   = ОписаниеЯзыка+
                                  ", "+
                                  Lo(Газета.Языки.Items[i].Язык.НаимБибл);  -- то считывается сокращенное библиографическое наименование языка
              end;
            end;
          end;
        end;--Газета.Языки.Count>0
        --языки - описание
        if ОписаниеЯзыка<>nil                                           then
          if SubStr(Result,Length(Result),1)<>"."                       then
                Result  = Result+".";
          end;
                Result  = Result+" - "+ОписаниеЯзыка;
        end;--ОписаниеЯзыка<>nil
        --определение необходимости вставки тире и разрыва строки
        if Газета.ПримечаниеБиблиографа<>nil                            then
          if ОписаниеЯзыка<>nil                                         or
            (Периодичность<>nil                                         and
             Периодичность<>"Неопределенно")                            then
                Result  = Result+" - ";
          end;
        else
          if SubStr(Result,Length(Result),1)<>Chr(13)                   then
                Result  = Result+Chr(13);
          end;
        end;
        --но:
        if Газета.ПримечаниеБиблиографа<>nil                            then
                Result  = Result+Газета.ПримечаниеБиблиографа+Chr(13);
        end;
        --НОМЕРА (1): в непрекращенной и не менявшей название газете
        Q               = Query.Create([РКП_Газеты.ВыпускГазеты]);
        Q.Filter        = 'Газета='+Str(Газета)+" and ГодВыпуска>="+Str(Газета.ГодЛетописи-1);
        Q.Order         = 'ГодВыпуска';
        Q.Select;
        Q.First;
        for k = 1..Q.Count                                              do --начало цикла по годам
          if k>1                                                        then
                Result  = Result+" ;";
          fi;
          if k=1                                                        then
                Result  = Result+Str(Q.Current.ГодВыпуска);
            if НомеровПолучено(Газета,Q.Current.ГодВыпуска)=0           then
                Result  = Result+'*';
            end;
          else
                Result  = Result+" "+Str(Q.Current.ГодВыпуска);
          end;
            if SubStr(Result,Length(Result),1)<>'*'                     then
                Result  = Result+"2, 0№2 0";
            end;
          --тест на ломку нумерации
          Q2            = Query.Create([РКП_Газеты.НомерГазеты]);
          Q2.Filter     = 'Газета='+Str(Газета)+' and ГодВыпуска='+Str(Q.Current.ГодВыпуска)+' and НеПолучен=false';
          Q2.Order      = "СерияНумерации;Номер";
          Q2.Select;
          if Q2.Count>0                                                 then
            Q2.First;
            Серия_От    = Q2.Current.СерияНумерации;
            Q2.Last;
            Серия_ДО    = Q2.Current.СерияНумерации;
            Серий       = Серия_ДО+1-Серия_От;
            ПериодСерии = "";
            --конец теста
            for серия=Серия_От+1..Серия_ДО+1                            do --начало цикла по сериям
              номер_0   ='';
              номер_1   ='';
              номер_2   ='';
              номера    ='';
              Q3        = Query.Create([РКП_Газеты.НомерГазеты]);
              Q3.Filter = 'Газета='+Str(Газета)+' and ГодВыпуска='+Str(Q.Current.ГодВыпуска)+' and СерияНумерации='+Str(серия-1);
              Q3.Order  = 'СерияНумерации+;Номер+';
              Q3.Select;
              if Q3.Count>0                                             then
                Q3.First;
                if  NoSpace(Q3.Current.Номер)="1"                       and 
                    Q3.Current.НеПолучен=true                           then
                номер_0         = NoSpace(Q3.Current.Номер)+'*';
                номер_1         = NoSpace(Q3.Current.Номер)+'*';
                else
                номер_0         = NoSpace(Q3.Current.Номер);
                номер_1         = NoSpace(Q3.Current.Номер);
                end;
                ВаловыйНомер    = NoSpace(Q3.Current.ВаловыйНомер);
                if ВаловыйНомер<>nil                                    then
                  номер_1       = номер_1+' ('+ВаловыйНомер+')';
                end;
              end;--Q3.Count>0
              --if Серий >1                                               then

              --if Серий >1 or(номер_1<>'1' and номер_1<>'1*')            then
              if Серий >1 or(номер_0<>'1' and номер_0<>'1/2' and номер_0<>'1*')            then   --29.04.2009
                if     Q3.Current.ТочностьДатыВыхода=0                  then
                ПериодСерии      ='('+ВСтроку(Q3.Current.ДатаВыхода,dfDMMMMM);
                elsif  Q3.Current.ТочностьДатыВыхода=1                  then
                ПериодСерии      ='('+ВСтроку(Q3.Current.ДатаВыхода,dfMMM);
                elsif  Q3.Current.ТочностьДатыВыхода=1                  then
                ПериодСерии      ='('+ВСтроку(Q3.Current.ДатаВыхода,dfYYYY);
                end;
              end;
              Q3.Close;
              --
              Q3        = Query.Create([РКП_Газеты.НомерГазеты]);
              Q3.Filter = 'Газета='+Str(Газета)+' and ГодВыпуска='+Str(Q.Current.ГодВыпуска)+' and СерияНумерации='+Str(серия-1);
              Q3.Order  = 'СерияНумерации-;Номер-';
              Q3.Select;
              if Q3.Count>0                                             then
                Q3.First;
                номер_2         = NoSpace(Q3.Current.Номер);
                ВаловыйНомер    = NoSpace(Q3.Current.ВаловыйНомер);
                if ВаловыйНомер<>nil                                    then
                  номер_2       = номер_2+' ('+ВаловыйНомер+')';
                end;
              end;--Q3.Count>0
              --if Серий >1 or(номер_1<>'1' and номер_1<>'1*')            then
              if Серий >1 or(номер_0<>'1' and номер_0<>'1/2' and номер_0<>'1*')            then   --29.04.2009
                if     Q3.Current.ТочностьДатыВыхода=0                  then
                  if ПериодСерии<>'('+ВСтроку(Q3.Current.ДатаВыхода,dfDMMMMM)     then
                    ПериодСерии      = ПериодСерии+' - '+ВСтроку(Q3.Current.ДатаВыхода,dfDMMMMM)+')';
                  else
                    ПериодСерии      = ПериодСерии+')';
                  end;
                elsif  Q3.Current.ТочностьДатыВыхода=1                  then
                  if ПериодСерии<>'('+ВСтроку(Q3.Current.ДатаВыхода,dfMMM)     then
                    ПериодСерии      = ПериодСерии+' - '+ВСтроку(Q3.Current.ДатаВыхода,dfMMM)+')';
                  else
                    ПериодСерии      = ПериодСерии+')';
                  end;
                elsif  Q3.Current.ТочностьДатыВыхода=2                  then
                  if ПериодСерии<>'('+ВСтроку(Q3.Current.ДатаВыхода,dfYYYY)     then
                    ПериодСерии      = ПериодСерии+' - '+ВСтроку(Q3.Current.ДатаВыхода,dfYYYY)+')';
                  else
                    ПериодСерии      = ПериодСерии+')';
                  end;
                end;
              end;
              Q3.Close;
              --формирование описания выпущенных номеров
              if номер_1=номер_2                                        then
                номера          = номер_1;
              else
               номера           = номер_1+'-'+номер_2;
              end;
             if ПериодСерии<>nil                                        then
               номера           = номера+' '+ПериодСерии;
             fi;
             if серий=1 or серия=серия_до+1                             then
               if SubStr(номера,1,1)<>'№'                               and
                  SubStr(Result,Length(Result)-1,1)<>'№'                then
                Result  = Result+'№ '+номера+". ";
               else
                Result  = Result+номера+". ";
               end;
             else
               if SubStr(номера,1,1)<>'№'                               and
                  SubStr(Result,Length(Result)-1,1)<>'№'                then
                Result  = Result+'№ '+номера+", ";
               else
                Result  = Result+номера+", ";
               end;
             fi;
            end;--конец цикла по сериям
            --формирование описания тиража выпуска (точно)
            QResult     = Q2.CalcAggregates("Count,Sum(Тираж)") as Variant[];
            тираж       = Str(Round((QResult[2]/QResult[1])));
            if Length(тираж) > 3                                        then
              тираж     = SubStr(тираж,1,Length(тираж)-3)+' '+SubStr(тираж,Length(тираж)-2,3);
            end;
            if Length(тираж) > 7                                        then
              тираж     = SubStr(тираж,1,Length(тираж)-7)+' '+SubStr(тираж,Length(тираж)-6,7);
            end;
            if Length(тираж) > 10                                       then
              тираж     = SubStr(тираж,1,Length(тираж)-10)+' '+SubStr(тираж,Length(тираж)-9,10);
            end;
            тираж       = тираж+' экз.';
                Result  = Result+"- "+тираж;
          end;--конец условия на ненулевое количество газет в годе выпуска
          Q2.Close;
          Q.Next;
        end;--k конец цикла по годам
        Q.Close;
   Return Result;
  end;


--/////////////////////////////////////////////////////////////////////////////////
  func ФормированиеОписанияОтсылки(Газета:Газета):string;
  var МестоИзданияГазеты        : String;
  var ПоследнийСимволНазвания   : String;
  var ОписаниеЯзыка             : string;
  var i                         : integer;
--    if Газета.МестаИздания.Items[1].МестоИздания.НаимБибл<>nil          then
--      МестоИзданияГазеты        = Газета.МестаИздания.Items[1].МестоИздания.НаимБибл;
--    else
--      МестоИзданияГазеты        = Газета.МестаИздания.Items[1].МестоИздания.Наим;
--    end;
      МестоИзданияГазеты        = Газета.МестаИздания.Items[1].МестоИздания.Наим;
    --языки - вычисление
    if Газета.Языки.Count>0                                             then    --если указан язык издания газеты
      if Газета.Языки.Items[1].Язык.ГосЯзРФ=false                       then    -- если указанный язык не является государственным языком РФ
        for i=1..Газета.Языки.Count                                     do
          if i=1                                                        then
            ОписаниеЯзыка   = Газета.Языки.Items[i].Язык.НаимБибл;          -- то считывается сокращенное библиографическое наименование языка
          else
            ОписаниеЯзыка   = ОписаниеЯзыка+" ; "+Газета.Языки.Items[i].Язык.НаимБибл;  -- то считывается сокращенное библиографическое наименование языка
          end;
        end;
      end;
    end;--Газета.Языки.Count>0
    ПоследнийСимволНазвания = SubStr(Газета.НазваниеОсн,Length(Газета.НазваниеОсн),1);
    if ПоследнийСимволНазвания<>"!"                                     and
       ПоследнийСимволНазвания<>"?"                                     and
       ПоследнийСимволНазвания<>"."                                     and
       ПоследнийСимволНазвания<>'"'                                     then    --если название НЕ заканчивается на "!" ,"?" или "..." или '"'
                Result  = ". - ";
    else
                Result  = " - ";
    end;
    if МестоИзданияГазеты<>nil                                          then
                Result  = Result+МестоИзданияГазеты;
    end;
    if ОписаниеЯзыка<>nil                                               then
                Result  = Result+". - ";
                Result  = Result+ОписаниеЯзыка;
    end;
    --ликвидация первой замыкающей точки
    if SubStr(Result,Length(Result),1)='.'                              then
                Result  = SubStr(Result,1,Length(Result)-1);
    end;
    --ликвидация вторй замыкающей точки
    if SubStr(Result,Length(Result),1)='.'                              then
                Result  = SubStr(Result,1,Length(Result)-1);
    end;
                Result  = Result+". - См. ";
                Result  = Result+Str(Газета.Отсылка.НомерВЛетописи)+".";
   Return Result;
  end;




inobject

end