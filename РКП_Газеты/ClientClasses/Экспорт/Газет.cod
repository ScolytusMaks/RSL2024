class  '';

InClass Public
  proc СоздатьЗаписьРКП(R:РКП_Газеты.Газета;var ЭкспортРКПДанные[]:string;var КолСтрок:integer);
  --proc СоздатьЗаписьРКП(Rec:record;var ЭкспортРКПДанные[]:string;var КолСтрок:integer);
  var k,z       : integer;
  var Q         : Query;
  var rr        : record;
    if (R<>nil)                                                                 then
  --Порядковый номер записи --==================================================
  --2_0010. - Идентификатор типа данных=============================================
  k                             = k+1;
  ЭкспортРКПДанные[k]           = '001 ГЗ';
  --2_0004. - Номер записи на газету в целом========================================
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '004 '+РКП_СИС.StdCode.FixStr(Str(R.DocId),"0",10);
  #Warning "Поле 015 описывает номер записи в ЛППИ?";
  --015 - N записи в ЛППИ ? ====================================================
  if R.НомерВЛетописи<> nil                                                     then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '015 '+Str(R.НомерВЛетописи);
  end;
  --022 - ISSN действующий======================================================
  if R.ISSN<> nil and Match(R.ISSN,"????-????")=true                            then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '022 '+R.ISSN;
  end;
  --023 - ISSN Замененный (запрещенный)=========================================
  --024 - Номер свидетельства регистрации газеты================================(из примера)
  if R.РегНомер<> nil                                                             then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '024 '+R.РегНомер;
  end;
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --207 - Фактографические сведения о газете====================================
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '207 Сведения о газете';
  --207 ^a - Дата начала выхода сериального издания=============================
  if R.ДатаВыходаПервогоНомера <> nil                                           then
  k                             = k+1;
    if    R.ТочностьДатыПервогоНомера = 0                                       then
  ЭкспортРКПДанные[k]            = '^a'+РКП_СИС.DateDescription.ToString(R.ДатаВыходаПервогоНомера, РКП_СИС.DateDescription.dfYYYYDDMMM);
    elsif R.ТочностьДатыПервогоНомера = 1                                       then
  ЭкспортРКПДанные[k]            = '^a'+РКП_СИС.DateDescription.ToString(R.ДатаВыходаПервогоНомера, РКП_СИС.DateDescription.dfYYYYMMM);
    elsif R.ТочностьДатыПервогоНомера = 2                                       then
  ЭкспортРКПДанные[k]            = '^a'+РКП_СИС.DateDescription.ToString(R.ДатаВыходаПервогоНомера, РКП_СИС.DateDescription.dfYYYY);
    end;
  end;
  --207 ^b - Дата прекращения выхода сериального издания========================
  if R.ДатаВыходаПоследнегоНомера <> nil                                        then
  k                             = k+1;
    if    R.ТочностьДатыПоследнегоНомера = 0                                    then
  ЭкспортРКПДанные[k]            = '^b'+РКП_СИС.DateDescription.ToString(R.ДатаВыходаПоследнегоНомера, РКП_СИС.DateDescription.dfYYYYDDMMM);
    elsif R.ТочностьДатыПоследнегоНомера = 1                                    then
  ЭкспортРКПДанные[k]            = '^b'+РКП_СИС.DateDescription.ToString(R.ДатаВыходаПоследнегоНомера, РКП_СИС.DateDescription.dfYYYYMMM);
    elsif R.ТочностьДатыПоследнегоНомера = 2                                    then
  ЭкспортРКПДанные[k]            = '^b'+РКП_СИС.DateDescription.ToString(R.ДатаВыходаПоследнегоНомера, РКП_СИС.DateDescription.dfYYYY);
    end;
  end;
  --207 ^c - Тип газеты (статус)================================================
  if R.ТерриторияРаспространения <> nil                                         then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '^c'+R.ТерриторияРаспространения.Наим;
  end;
  --207 ^d - Язык текста газеты=================================================
  k                             = k+1;
  if   R.Языки.Count > 0                                                        then
    if  R.Языки.Items[1].Язык <> nil                                            then
  ЭкспортРКПДанные[k]            = '^d'+R.Языки.Items[1].Язык.НаимБибл;
    else
  ЭкспортРКПДанные[k]            = '^dрус.';
    end;
  else
  ЭкспортРКПДанные[k]            = '^dрус.';
  end;
  --207 ^e - Страна (республика, край, область) газеты==========================
  #Warning "Поле 207  в каких случаях требуется указание надструктуры в иерархии административных связей РФ? До какого и с какого уровня?";
  if   R.МестаИздания.Count > 0                                                 then
    if  R.МестаИздания.Items[1].МестоИздания <> nil                             then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '^e' + РКП_Справочники.BiblioRecord.ПодчинениеГео(R.МестаИздания.Items[1].МестоИздания);
    end;
  end;
  --207 ^f - Читательский адрес=================================================
  if   R.ЧАЦН.Count > 0                                                         then
    if  R.ЧАЦН.Items[1].ЧАЦН <> nil                                             then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '^f'+R.ЧАЦН.Items[1].ЧАЦН.Наим;
    end;
  end;
  --207 ^g - Тематика===========================================================
  if   R.Тематики.Count > 0                                                     then
    if  R.Тематики.Items[1].Тематика <> nil                                     then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '^g'+R.Тематики.Items[1].Тематика.Наим;
    end;
  end;
  --207 ^h - Иллюстрированные газеты============================================
  --207 ^i - Периодичность выхода газеты========================================
  if R.Периодичность <> ""                                                      then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '^i'+R.Периодичность;
  end;
  --207 ^j - Регулярность выхода газеты=========================================
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --            Заглавие и сведения об ответственности
  --245 - Основное заглавие=====================================================
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '245 '+R.НазваниеОсн;
  --245 ^: - сведения, относящиеся к заглавию====================================
  if R.Подзаголовок <> ""                                                       then
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+" ^: "+R.Подзаголовок;
  end;
  --245 ^= - альтеранативное заглавие газеты: Заглавие на языке народов РФ======
  if R.НазваниеИнЯз <> ""                                                       then
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+'^= '+R.НазваниеИнЯз;
  end;
  --245 ^= - альтеранативное заглавие: заглавие на другом языке (кроме языков РФ)
  if R.НазваниеНацЯз <> ""                                                      then
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+'^= '+R.НазваниеНацЯз;
  end;
  --245 ^/ - Основные сведения об ответственности: редакторы,  коллективные авторы,  учредители
  if R.Учред <> nil                                                             then
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+'^/ '+R.Учред;
  end;
  --245 ^; - Последующие  сведения об ответственности: редакторы,  коллективные авторы,  учредители
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --            Блок взаимосвязанных заглавий газеты
  --530 - Ключевое заглавие======================================================
  --530 ^: - Аббревиатура ключевого заглавия=====================================
  --531 - Сокращенное заглавие===================================================
  --520 - Прежнее заглавие=======================================================
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --            Специальные данные по нумерация сериальных изданий
  --257 ^А - Номер первого выпуска издания газеты================================
  --257 ^Б - год выхода первого выпуска газеты===================================
  if R.ДатаВыходаПервогоНомера <> nil                                           then
  #Warning "Поле 257^a описывает ДАТУ (не номер) выхода первого номера";
  if    R.ТочностьДатыПервогоНомера=0                                           then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^a'+Str(R.ДатаВыходаПервогоНомера);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^b'+Str(Year(R.ДатаВыходаПервогоНомера));
  elsif R.ТочностьДатыПервогоНомера=1                                           then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^a'+Str(R.ДатаВыходаПервогоНомера);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^b'+РКП_СИС.DateDescription.ToString(R.ДатаВыходаПервогоНомера, РКП_СИС.DateDescription.dfYYYYMMM);
  elsif R.ТочностьДатыПервогоНомера=2                                           then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^b'+Str(Year(R.ДатаВыходаПервогоНомера));
  end;
  end;
  --#Warning "Поле 257^В описывает последний выпущенный, полученный номер или номер прекращения?";
  --257 ^В - Номер последнего выпуска  газеты====================================
  --257 ^Г - год последнего выпуска газеты=======================================
  --257 ^Д - Перерывы в выходе газеты (интервал дат)=============================
  --257 ^Е - Изменение нумерации выпусков газеты=================================
  --257 ^Ж - Возобновление нумерации выпусков газеты=============================
2_  --Argo:
  --Четверка cdef описывает номер, валовый номер, дату и год последнего выпущенного номера
   rr                           = РКП_Газеты.Стат.ПоследнийВыпущенныйНомер(R);
     if rr<>nil                                                                 then
       if rr.Номер<>nil and Pos("нену",rr.Номер)=0                              then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^c'+rr.Номер;
       end;
       if rr.ВаловыйНомер<>nil                                                  then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^d'+rr.ВаловыйНомер;
       end;
       if rr.ДатаВыхода<>nil                                                    then
         if    rr.ТочностьДатыВыхода = 0                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^e'+Str(rr.ДатаВыхода);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^f'+Str(Year(rr.ДатаВыхода));
         elsif rr.ТочностьДатыВыхода = 1                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^e'+РКП_СИС.DateDescription.ToString(rr.ДатаВыхода,РКП_СИС.DateDescription.dfYYYYMMM);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^f'+Str(Year(rr.ДатаВыхода));
         elsif rr.ТочностьДатыВыхода = 2                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^f'+Str(Year(rr.ДатаВыхода));
         end;
       end;
     end;
  --Четверка ghij описывает номер, дату и год последнего зарегистрированного в РКП номера
   rr                           = РКП_Газеты.Стат.ПоследнийПолученныйНомер(R);
     if rr<>nil                                                                 then
       if rr.Номер<>nil and Pos("нену",rr.Номер)=0                              then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^g'+rr.Номер;
       end;
       if rr.ВаловыйНомер<>nil                                                  then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^h'+rr.ВаловыйНомер;
       end;
       if rr.ДатаВыхода<>nil                                                    then
         if    rr.ТочностьДатыВыхода = 0                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^i'+Str(rr.ДатаВыхода);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^j'+Str(Year(rr.ДатаВыхода));
         elsif rr.ТочностьДатыВыхода = 1                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^i'+РКП_СИС.DateDescription.ToString(rr.ДатаВыхода,РКП_СИС.DateDescription.dfYYYYMMM);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^j'+Str(Year(rr.ДатаВыхода));
         elsif rr.ТочностьДатыВыхода = 2                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^j'+Str(Year(rr.ДатаВыхода));
         end;
       end;
     end;
  --Четверка klmn описывает номер, дату и год номера прекращения газеты
   rr                           = РКП_Газеты.Стат.НомерПрекращения(R);
     if rr<>nil                                                                 then
       if rr.Номер<>nil and Pos("нену",rr.Номер)=0                              then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^k'+rr.Номер;
       end;
       if rr.ВаловыйНомер<>nil                                                  then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^l'+rr.ВаловыйНомер;
       end;
       if rr.ДатаВыхода<>nil                                                    then
         if    rr.ТочностьДатыВыхода = 0                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^m'+Str(rr.ДатаВыхода);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^n'+Str(Year(rr.ДатаВыхода));
         elsif rr.ТочностьДатыВыхода = 1                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^m'+РКП_СИС.DateDescription.ToString(rr.ДатаВыхода,РКП_СИС.DateDescription.dfYYYYMMM);
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^n'+Str(Year(rr.ДатаВыхода));
         elsif rr.ТочностьДатыВыхода = 2                                        then
    k                            = k+1;
    ЭкспортРКПДанные[k]          = '257 ^n'+Str(Year(rr.ДатаВыхода));
         end;
       end;
     end;
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --            Выходные данные газеты
  --260 - Место издания газеты (первое)==========================================
  if   R.МестаИздания.Count > 0                                                 then
    if  R.МестаИздания.Items[1].МестоИздания <> nil                             then
  k                             = k+1;
      for z  = 1..R.МестаИздания.Count                                          do
      if  z = 1                                                                 then
      if  R.МестаИздания.Items[z].МестоИздания.НаимБибл <> nil                  then
  ЭкспортРКПДанные[k]            = '260 '+R.МестаИздания.Items[z].МестоИздания.НаимБибл;
      else
  ЭкспортРКПДанные[k]            = '260 '+R.МестаИздания.Items[z].МестоИздания.Наим;
      end;--условие на наличие сокращенного (библ.) названия
      else --вторые места издания
      if  R.МестаИздания.Items[z].МестоИздания.НаимБибл <> nil                  then
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+' ^;'+R.МестаИздания.Items[z].МестоИздания.НаимБибл;
      else
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+' ^;'+R.МестаИздания.Items[z].МестоИздания.Наим;
      end;--условие на наличие сокращенного (библ.) названия
      end;--условие на первое место
      end;--цикл по местам изданий
  --260 ^, - Год издания  (выпуска)==============================================
  Q                             = Query.Create([РКП_Газеты.ВыпускГазеты]);
  Q.Filter                      = "Газета="+Str(R);
  Q.LoadingFields               = "ГодВыпуска";
  Q.Order                       = "ГодВыпуска";
  Q.Select;
    if Q.Count>0                                                                then
      Q.Last;
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+' ^,'+Str(Q.Current.ГодВыпуска);
    end;
  Q.Close;
  --260 ^( - Адрес редакции (издателя)===========================================
      if  R.Редакция <> nil                                                     then
  ЭкспортРКПДанные[k]           = ЭкспортРКПДанные[k]+' ^('+R.Редакция.Наим;
      end;
    end;
  end;
  --260 ^; - Место издания газеты (второе и последующие)=========================
  --260 ^: - Издатель 1-й========================================================
  --260 ^: - Издатель 2-й========================================================
  --261 - Место печати газеты (первое)===========================================
  --261 ^; - Место печати газеты (второе и последующие)==========================
  --261 ^: - Типография 1-я======================================================
  --261 ^: - Типография 2-я======================================================
  --261 ^, - Год издания  (выпуска)==============================================
  --261 ^( - Адрес типографии 1-й================================================
  --261 ^( - Адрес типографии 2-й================================================
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --            Количественная характеристика
  --302 - Число страниц (полос)==================================================
  --302 ^: - Сведения об иллюстрациях============================================
  --302 ^; - Размер в см=========================================================
  --302 ^+ - Сопроводительный материал (приложения)==============================
  Q                             = Query.Create([РКП_Газеты.ВыпускГазеты]);
  Q.Filter                      = "Газета="+Str(R);
  Q.Order                       = "ГодВыпуска";
  Q.Select;
    if Q.Count>0                                                                then
      Q.Last;
      if Q.Current.ЧислоПолос<>nil or Q.Current.ФорматВыпуска<>nil              then
  k                             = k+1;
        if Q.Current.ЧислоПолос<>nil                                            then
  ЭкспортРКПДанные[k]           = '302 '+Q.Current.ЧислоПолос;
        end;
        if Q.Current.ФорматВыпуска<>nil                                         then
          if ЭкспортРКПДанные[k]<>nil                                           then
  ЭкспортРКПДанные[k]           = ЭкспортРКПДанные[k]+' ^;'+Q.Current.ФорматВыпуска;
          else
  ЭкспортРКПДанные[k]           = '302 '+' ^;'+Q.Current.ФорматВыпуска;
          end;
        end;
      end;
    end;
  Q.Close;
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --            Дополнительные библиографические данные
  --550 - Примечания Об истории издания==========================================
  --567 - Примечания О языке издания=============================================
  --542 - Примечания О специальных, региональных, дополнительных выпусках========
  --541 - Примечания Сведения о предыдущих названиях (сведения о связи с другими изданиями)
  --856 - Наличие и размещение электронной версии газеты=========================
  if R.HTTP <> nil                                                              then
  k                             = k+1;
  ЭкспортРКПДанные[k]            = '856 '+R.HTTP;
  end;
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --            Сведения о выпуске газеты
  --2_0004. - Номер записи на газету в целом========================================
  --208 - Данные по газете за год===============================================
  --208 ^a - год================================================================
  --208 ^b - периодичность======================================================
  --208 ^c - формат=============================================================
  --208 ^d - Число полос========================================================
  --208 ^e - Средний разовый тираж==============================================
  --208 ^f - Годовой тираж======================================================
  --208 ^g - Всего номеров======================================================
  --208 ^h - Последний валовый номер============================================
  --208 ^i - Примечание=========================================================
  -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  --246 - Номер выпуска газеты==================================================
  --246 ^; - Название выпуска газеты============================================
  --246 ^: - Валовая нумерация выпусков газеты==================================
  --262 ^; - Дата издания выпуска газеты========================================
  --537 - Тираж выпуска=========================================================
  --801 - Создатель записи
  if R.CreateUser <> nil or R.CreateDate <> nil                                 then
  k                             = k+1;
    if  R.CreateUser <> nil                                                     then
  ЭкспортРКПДанные[k]            = '801 '+R.CreateUser;
    end;
    if R.CreateDate <> nil                                                      then
      if  ЭкспортРКПДанные[k] <> nil                                            then
  ЭкспортРКПДанные[k]            = ЭкспортРКПДанные[k]+' ^d'+Str(Dat(Day(R.CreateDate),Mon(R.CreateDate),Year(R.CreateDate)));
      else
  ЭкспортРКПДанные[k]            = '801 ^d'+Str(Dat(Day(R.CreateDate),Mon(R.CreateDate),Year(R.CreateDate)));
      end;
    end;
  end;
  --054 - Дата ввода  записи в файл=============================================
  --END----END----END----END----END----END----END----END----END----END----END---
    КолСтрок    = k;
    end;
  end;

  proc Синхронизация(R:РКП_Газеты.Газета;ЭкспортРКПДанные[]:string);
    --////////////////////////////////////////////////////////////////////////--
    --==== СИНХРОНИЗАЦИЯ МАССИВА СТРОК ЭКСПОРТА С ПОДТАБЛИЦЕЙ ==================
    --////////////////////////////////////////////////////////////////////////--
    var КолСтрок        : integer;
    var k,kk,z          : integer;
    КолСтрок                            = LengthOfArray(ЭкспортРКПДанные);
    --удаление лишних записей
    if  R.ЭкспортРКП.Count > КолСтрок                           then
      kk                                = R.ЭкспортРКП.Count;
      for k = 1..kk                     do
        if kk+1-k>КолСтрок and kk>0                             then
          R.ЭкспортРКП.Delete(kk+1-k);
        end;
      end;
    end;
    --сравнение
    for k = 1..КолСтрок                 do
      if k<=R.ЭкспортРКП.Count                                  then
        z = k;
        if R.ЭкспортРКП[z].Данные<>ЭкспортРКПДанные[z]          then
          R.ЭкспортРКП[z].Данные        = ЭкспортРКПДанные[z];
        end;
      else
        z                               =  R.ЭкспортРКП.Add;
        R.ЭкспортРКП[z].Данные          = ЭкспортРКПДанные[z];
      end;
    end;--цикл по массиву


  end;

InObject Private

end