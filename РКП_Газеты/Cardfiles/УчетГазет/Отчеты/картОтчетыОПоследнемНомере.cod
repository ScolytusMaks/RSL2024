Class inherited СИС2.картБазовая "Отчеты о последнем полученном номере";

InClass Public

InObject Private
ТипИздания      : integer;
ГодВыпуска      : integer;
var Литера_[]   : string;


--------------------------------------------------------------------------------
proc СозданиеМассиваЛитер;
Литера_ = nil;
Литера_[1]='"';Литера_[2]='@';Литера_[3]='+';Литера_[4]='-';Литера_[5]='=';
Литера_[6]='0';Литера_[7]='1';Литера_[8]='2';Литера_[9]='3';Литера_[10]='4';
Литера_[11]='5';Литера_[12]='6';Литера_[13]='7';Литера_[14]='8';Литера_[15]='9';
Литера_[16]='A';Литера_[17]='B';Литера_[18]='C';Литера_[19]='D';Литера_[20]='E';
Литера_[21]='F';Литера_[22]='G';Литера_[23]='H';Литера_[24]='I';Литера_[25]='J';
Литера_[26]='K';Литера_[27]='L';Литера_[28]='M';Литера_[29]='N';Литера_[30]='O';
Литера_[31]='P';Литера_[32]='Q';Литера_[33]='R';Литера_[34]='S';Литера_[35]='T';
Литера_[36]='U';Литера_[37]='V';Литера_[38]='W';Литера_[39]='X';Литера_[40]='Y';Литера_[41]='Z';
Литера_[42]='А';Литера_[43]='Б';Литера_[44]='В';Литера_[45]='Г';Литера_[46]='Д';
Литера_[47]='Е';Литера_[48]='Ё';Литера_[49]='Ж';Литера_[50]='З';Литера_[51]='И';
Литера_[52]='К';Литера_[53]='Л';Литера_[54]='М';Литера_[55]='Н';Литера_[56]='О';
Литера_[57]='П';Литера_[58]='Р';Литера_[59]='С';Литера_[60]='Т';Литера_[61]='У';
Литера_[62]='Ф';Литера_[63]='Х';Литера_[64]='Ц';Литера_[65]='Ч';Литера_[66]='Ш';
Литера_[67]='Щ';Литера_[68]='Ъ';Литера_[69]='Ы';Литера_[70]='Ь';Литера_[71]='Э';
Литера_[72]='Ю';Литера_[73]='Я';
end;


proc ВидКартотеки;
  if ГодВыпуска=0 then
  CardFile.ColumnByField["ГодВыпуска"].Visible=false;
  else
  CardFile.ColumnByField["ГодВыпуска"].Visible=true;
  end;
  CardFile.Filter="ТипИздания="+Str(ТипИздания)+" and "+"ГодВыпуска="+Str(ГодВыпуска);
end;

--{ Обработчики событий картотеки

  proc шаблон_ПриОткрытии(Create :Logical);
    if   ГодВыпуска<1800        and
         ГодВыпуска<>0          then
      ГодВыпуска        = Year(today);
    end;
    ВидКартотеки;
  end;

  proc ОбновитьЗапросПоУсловию(Sender :Button);
  var j,k,kk,n          : integer;
  var Q                 : query;
  var ЕстьРезультат     : logical;
  var R                 : record;
  var mR[]              : record;
  var Номер_[]          : record;

    --1. Проверка на существование, создание недостающих записей
    --1.1. Проверка корректности запроса
    if ГодВыпуска<1801 and ГодВыпуска<>0        then
      Message("Пожалуйста, укажите корректный год!");
      Self.Template.Field       = "ГодВыпуска";
    else
      if  EnqOkCancel("Обновить результаты по состоянию на "+Str(today)+"?")=CmOk       then
    --1.2.
      СозданиеМассиваЛитер;
    --1.3. Цикл по массиву
      for j = 1..73             do
        Hint("Выполнение: <<"+Литера_[j]+">>",j,73);
        Q                   = Query.Create([РКП_Газеты.СправкаПоПоследнемуНомеру]);
        Q.Filter            = "ДатаЗапроса="+str(today)+" and "+
                              "ГодВыпуска="+str(ГодВыпуска)+" and "+
                              "ТипИздания="+Str(ТипИздания)+" and "+
                              "Литера='"+Литера_[j]+"'";
        Q.Select;
        if    Q.Count=1         then
          ЕстьРезультат = true;
          Q.First;
          R             = Q.Current;
        elsif Q.Count>1         then
          mR            = nil;
          Q.First;
          for k = 1..Q.Count do
            mR[k]       = Q.Current;
            Q.Next;
          end;
          kk            = Q.Count;
          for k = 2..kk      do
            mR[k].Delete;
          end;
          ЕстьРезультат = true;
          R             = mR[1];
        else
          ЕстьРезультат = false;
          R             = nil;
        end;
        Q.Close;
        if ЕстьРезультат=false  then
          R             = РКП_Газеты.СправкаПоПоследнемуНомеру.Create;
          R.ТипИздания  = ТипИздания;
          R.ГодВыпуска  = ГодВыпуска;
          R.ДатаЗапроса = today;
          R.Литера      = Литера_[j];
          --......Выполнение запроса...........(1)
          Номер_        = nil;
          ПоследнийНомер.ВыполнениеЗапроса(Литера_[j],ГодВыпуска,ТипИздания,Номер_);
          for n = 1..LengthOfArray(Номер_)      do
             R.Позиции.Add;
            R.Позиции.Items[n].Номер    = Номер_[n];
          end;
          R.Post;
        else
          --if R.ДатаЗапроса<>today       then
          R.ДатаЗапроса = today;
          --......Выполнение запроса...........(2)
          Номер_        = nil;
          R.Позиции.Clear;
          ПоследнийНомер.ВыполнениеЗапроса(Литера_[j],ГодВыпуска,ТипИздания,Номер_);
          for n = 1..LengthOfArray(Номер_)      do
            R.Позиции.Add;
            R.Позиции.Items[n].Номер    = Номер_[n];
          end;
          if R.Modified=true                    then
          R.Post;
          end;
          --end;
        end;--добавление записи
      end;--цикла1 по литерам
      end;--подтветждение
    end;--проверка корректности года
  end;

  proc ПолеГодВыпускаПриВыходе(Cell :TemplateCell; Index :Integer);
    ВидКартотеки;
  end;

  func ПолеГодВыпускаПриОбзоре(Cell :TemplateCell; Value :Variant;var NewValue :Variant) :Logical;
    var locYear :Integer;
    if (cmOk = РКП_СИС.Сервис.блВыборГода.ВыполнитьВыбор(locYear)) then
      NewValue = locYear;
      Template.EndEdit(true);
      ВидКартотеки;
    fi;
    --if  CmOk = OpenBlank("РКП_СИС.Сервис.блВыборГода",Window.ModalWindow) then
    --  NewValue     = РКП_СИС.Сервис.блВыборГода.Решение;
    --  ГодВыпуска   = NewValue;
    --  Template.EndEdit(True);
    --  if Value>1901 then
    --    РКП_СИС.Сервис.блВыборГода.ВыбранныйГод = Value;
    --  else
    --    РКП_СИС.Сервис.блВыборГода.ВыбранныйГод = Year(Today)-1;
    --  end;
    --end;
    --ВидКартотеки;
    --Result = false;
  end;

  proc ПолеТипИзданияПриВыходе(Cell :TemplateCell; Index :Integer);
    ВидКартотеки;
  end;

  proc кнПечать_ПриНажатии(Sender :Button);
  var i : integer;
  var BlankForPrint  : BlankForm;
    if Cardfile.SelectedCount=0         then
      Message('Для выполнения этой команды должна быть выделена хотя бы одна запись. Выделение выполняется клавишами Shif+стрелка вниз / Shif+стрелка вверх');
    end;
    for i = 1..Cardfile.SelectedCount   do
      Trace('Текущая запись ' + Str(Cardfile.Selected[i])+' : ' +Cardfile.Selected[i].Литера +'...');
      BlankForPrint     = РКП_Газеты.УчетГазет.Отчеты.редОтчетОПоследнемНомере.Create;
      #NoWarning;
      BlankForPrint.ShowEx(Cardfile.Selected[i]);
      BlankForPrint.Print;
      BlankForPrint.Close;
    end;

      
  end;

--}

end