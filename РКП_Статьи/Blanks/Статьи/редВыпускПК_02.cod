class inherited РКП_Статьи.Статьи.редВыпускПК_01 "Подготовка выпуска ПК - оригинал-макет", editor ВыпускПК;

Import РКП_СИС Classes StdCode;

inclass

inobject
--  MaxLng        : integer=570;--максимальная длина текста описания статьи на карточку
--  MinLng        : integer=510;--минимальная длина текста описания статьи на карточку (для длинных описаний)
  MaxLng        : integer=450;--максимальная длина текста описания статьи на карточку
  MinLng        : integer=390;--минимальная длина текста описания статьи на карточку (для длинных описаний)

--------------------------------------------------------------------------------
--{ Обработчики событий бланка

ПозицияПК       : integer[];
СтраницаПК      : string[];
ЗаголовкПК      : string[];
СодержаниеПК    : string[];
НомерПК         : string[];
УДКПК           : string[];
РКППК           : string[];
ББКПК           : string[];
ЗаписьПК        : record[];
секцПозицииПК   : TemplateSection;




  proc ФормированиеПК;
    var ПК                      : TextFile;
    var Q                       : Query;
    var k,l,sk                  : integer;
    var z,zz,dlt,v,u,b          : integer;
    var ДлинаОписанияСтатьи     : integer;
    var iОписаниеСтатьи         : string;
    var vОписаниеСтатьи         : string;

    var vСтраницаПК[]           : string;
    var vЗаголовкПК[]           : string;
    var vСодержаниеПК[]         : string;
    var vНомерПК[]              : string;
    var vУДКПК[]                : string;
    var vРКППК[]                : string;
    var vББКПК[]                : string;
    var vЗаписьПК[]             : record;
    var КолКарточекПродолжения  : integer;
    var ШифрВыпуска_            : string;

----Проверка шифра (29.01.2009)----------------------------------------------------------------------------
--   ШифрВыпуска_        = "Gk"+
--                       SubStr(Str(Year(ДатаВыпуска)),3,2)+
--                       FixStr(Str(ВыпускЛетописи),"0",2)+
--                       FixStr(Str(ВыпускКарточекЛ),"0",2);
      if ШифрВыпуска<>ШифрВыпуска_                         then
        ШифрВыпуска        = ШифрВыпуска_;
      end;
----Создание файла-----------------------------------------------------------------------------------------
      Hint("Создание печатных форм...",1,5);
      ОригиналМакет.ПК_01_Файл.Создание(ПапкаКарточек,ФайлКарточек,ПК);
----Описание параметров всего документа--------------------------------------------------------------------
      Hint("Создание печатных форм...",2,5);
      ОригиналМакет.ПК_02_ПарамДок.Создание(ПК);
----Создание массива значений карточек---------------------------------------------------------------------
      Hint("Создание печатных форм...",3,5);
      ПозицияПК         = nil;
      СтраницаПК        = nil;
      ЗаголовкПК        = nil;
      СодержаниеПК      = nil;
      НомерПК           = nil;
      УДКПК             = nil;
      РКППК             = nil;
      ББКПК             = nil;
      ЗаписьПК          = nil;
      Q                         = Query.Create([РКП_Статьи.Роспись]);
      Q.Filter                  = "Year(ДатаКарточек)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаКарточек="+Str(ДатаВыпуска)+
                                  " and ВыпускКарточек="+Str(ВыпускКарточек);
      Q.Order                   = "НомерЗаписиВВыпускеПК";
      Q.Select;
      Q.First;
        for k = 1..Q.Count                              do      --начало цикла по статьям
          --Hint("Создание печатных форм...",k,Q.Count);
          ДлинаОписанияСтатьи   = Length(Q.Current.ОписаниеСтатьи);
          if Q.Current.КолКарточекПродолжения>0         then
          КолКарточекПродолжения= Q.Current.КолКарточекПродолжения;
          else
          КолКарточекПродолжения= 1000;
          end;
          if ДлинаОписанияСтатьи<MaxLng                 or
             КолКарточекПродолжения=1                   then    --обработка коротких статей
            l                   = l+1;
            ЗаписьПК[l]         = Q.Current;
            ПозицияПК[l]        = l;
            СтраницаПК[l]       = "";
            СодержаниеПК[l]     = Q.Current.ОписаниеСтатьи;
            ЗаголовкПК[l]       = Q.Current.Заголовок;
            НомерПК[l]          = "№ "+Str(Q.Current.НомерЗаписиВВыпускеПК);
            РКППК[l]            = "\'a9Рос.кн.палата "+Str(Q.Current.ДатаКарточек);
            for u=1..Q.Current.ИндексУДК.Count          do
              if u=1                                    then
            УДКПК[l]            = "УДК "+Q.Current.ИндексУДК.Items[u].РубрикаУДК.КодУдк;
              else
            УДКПК[l]            = УДКПК[l]+" + "+Q.Current.ИндексУДК.Items[u].РубрикаУДК.КодУдк;
              end;
            end;
            for b=1..Q.Current.ИндексББК.Count          do
              if b=1                                    then
            ББКПК[l]            = "ББК "+Q.Current.ИндексББК.Items[b].РубрикаББК.КодБбк;
              else
            ББКПК[l]            = ББКПК[l]+" + "+Q.Current.ИндексББК.Items[b].РубрикаББК.КодБбк;
              end;
            end;
          else  --обработка ДЛИННЫХ статей
            iОписаниеСтатьи     = Q.Current.ОписаниеСтатьи;
            zz                  = Length(iОписаниеСтатьи);
            vОписаниеСтатьи     = "";
            sk                  = 0;
            for z = 1..zz                                       do      --цикл по символам описания, где z - позиция символа
              --if Mod(z,MinLng)=0                                then    --условие кратности 390 (MinLng)
              if Mod(z,MinLng)=0                                and
                 _sk+1<КолКарточекПродолжения.                    then    --условие кратности 390 (MinLng)
                dlt             = 0;                                    --дельта (приращение) = 0
                for dlt= 1..40                                  do      --цикл по символам остатка описания (для поиска места для разрыва строки)
                  if SubStr(iОписаниеСтатьи,z-1+dlt,1)=" "      then    --2условие разрыва0 текста и формирования подножия
                   l                    = l+1;
                   ЗаписьПК[l]          = Q.Current;
                   sk                   = sk+1;2 0                2--0счетчик продолжений карточки
                   ПозицияПК[l]         = l;
                   СтраницаПК[l]        = Str(sk);
                   СодержаниеПК[l]      = vОписаниеСтатьи+"\par\qr{см. след. карт}\par\qj";
                   ЗаголовкПК[l]        = Q.Current.Заголовок;
                   НомерПК[l]           = "№ "+Str(Q.Current.НомерЗаписиВВыпускеПК);
                   РКППК[l]             = "\'a9Рос.кн.палата "+Str(Q.Current.ДатаКарточек);
                   --.........обработка УДК.........................................................................
                   for u=1..Q.Current.ИндексУДК.Count          do
                     if u=1                                    then
                   УДКПК[l]             = "УДК "+Q.Current.ИндексУДК.Items[u].РубрикаУДК.КодУдк;
                     else
                   УДКПК[l]             = УДКПК[l]+" + "+Q.Current.ИндексУДК.Items[u].РубрикаУДК.КодУдк;
                     end;
                   end;
                   --.........обработка ББК.........................................................................
                   for b=1..Q.Current.ИндексББК.Count          do
                     if b=1                                    then
                   ББКПК[l]             = "ББК "+Q.Current.ИндексББК.Items[b].РубрикаББК.КодБбк;
                     else
                   ББКПК[l]             = ББКПК[l]+" + "+Q.Current.ИндексББК.Items[b].РубрикаББК.КодБбк;
                     end;
                   end;
                   --...............................................................................................
                    vОписаниеСтатьи     = "";
                    z=z+dlt;
                    break;
                  else --условие продолжения поиска места для разрыва
                      vОписаниеСтатьи   = vОписаниеСтатьи+SubStr(iОписаниеСтатьи,z-1+dlt,1);
                  end;--конец условия поиска места для разрыва текста
                end;--конец цикла по остаткам текста
              end;--конец условия кратности 390 (MinLng)
              vОписаниеСтатьи   = vОписаниеСтатьи+SubStr(iОписаниеСтатьи,z,1);
              --Форимрование финальной карточки объемной статьи
              --if z=zz _or sk+1=КолКарточекПродолжения.            then    --условие формирования финальной карточки
              if z=zz                                           then    --достигнут последний символ
                l                       = l+1;
                ЗаписьПК[l]             = Q.Current;
                sk                      = sk+1;
                ПозицияПК[l]            = l;
                СтраницаПК[l]           = Str(sk);
                СодержаниеПК[l]         = vОписаниеСтатьи;
                ЗаголовкПК[l]           = Q.Current.Заголовок;
                НомерПК[l]              = "№ "+Str(Q.Current.НомерЗаписиВВыпускеПК);
                РКППК[l]                = "\'a9Рос.кн.палата "+Str(Q.Current.ДатаКарточек);
                   --.........обработка УДК.........................................................................
                for u=1..Q.Current.ИндексУДК.Count          do --начало цикла по УДК
                  if u=1                                    then
                УДКПК[l]                = "УДК "+Q.Current.ИндексУДК.Items[u].РубрикаУДК.КодУдк;
                  else
                УДКПК[l]                = УДКПК[l]+" + "+Q.Current.ИндексУДК.Items[u].РубрикаУДК.КодУдк;
                  end;
                end;--конец цикла по УДК
                   --.........обработка ББК.........................................................................
                for b=1..Q.Current.ИндексББК.Count          do --начало цикла по ББК
                  if b=1                                    then
                ББКПК[l]            = "ББК "+Q.Current.ИндексББК.Items[b].РубрикаББК.КодБбк;
                  else
                ББКПК[l]            = ББКПК[l]+" + "+Q.Current.ИндексББК.Items[b].РубрикаББК.КодБбк;
                  end;
                end;--конец цикла по ББК
                   --...............................................................................................
                vОписаниеСтатьи     = "";
              end;--конец условия формирования финальной карточки
            end; --конец цикла по символам описания
          end;--конец условия на длину статьи
          Q.Next;
        end;--конец цикла по статьям
        секцПозицииПК.Count     = l;
      Q.Close;

----Формирование карточек на основе массива----------------------------------------------------------------
    Hint("Создание печатных форм...",4,5);
    for k = 1..секцПозицииПК.Count step 10                      do
         --условие кратности 10
      if Mod(k-1,10)=0 and k>1                                  then
                ПК.WriteLn("\sect");--разрыв страницы
      end;--условие кратности 10
      for v = 1..10                                             do
        vСтраницаПК[v]  =  СтраницаПК[k-1+v];
        vЗаголовкПК[v]  =  ЗаголовкПК[k-1+v];
        vСодержаниеПК[v]=  СодержаниеПК[k-1+v];
        vНомерПК[v]     =  НомерПК[k-1+v];
        vУДКПК[v]       =  УДКПК[k-1+v];
        vРКППК[v]       =  РКППК[k-1+v];
        vББКПК[v]       =  ББКПК[k-1+v];
        vЗаписьПК[v]    =  ЗаписьПК[k-1+v];
      end;
      ОригиналМакет.ПК_03_Лист.Создание(ПК,
                                        vСтраницаПК,
                                        vЗаголовкПК,
                                        vСодержаниеПК,
                                        vНомерПК,
                                        vУДКПК,
                                        vРКППК,
                                        vББКПК,
                                        vЗаписьПК
                                        );
    end;
    Hint("Создание печатных форм...",5,5);
                ПК.WriteLn("}");--замыкающая скобка-конец текста RTF
 end;--ФормированиеПК; v3






--}

end