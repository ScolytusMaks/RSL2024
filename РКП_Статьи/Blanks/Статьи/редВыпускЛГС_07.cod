class inherited Статьи.редВыпускЛГС_06 "Анализ номеров страниц", editor ВыпускЛГС;

inclass

inobject

--------------------------------------------------------------------------------
--{ Обработчики событий бланка
  proc СозданиеСодержания;
    var i,j,k           : integer;
    var КодОгл,НаимОгл  : string;
    var НомерСтроки     : integer;
    var TestStr         : string;
    var СтраницВСодержании,
        СтраницВПредисловии,
        СтраницВСпискеГодГазет,
        СтраницДоРаздела,
        СтраницСтатей,
        СтраницИУ,
        СтраницГУ,
        СтраницВСпискеНомерГазет

                        : integer;
    var Q               : Query;

    --1. Состав содержания в зависимости от попавшихся УДК и номера ЛГС
    Record.Содержание.Clear;
    if ВыпускЛетописи=1                                 then
      i                                 = Record.Содержание.Add;
      Record.Содержание[i].Глава        = "\b Предисловие\b0";
      i                                 = Record.Содержание.Add;
      Record.Содержание[i].Глава        = "\b Список газет, материалы из которых отражаются в \'abЛетописи газетных статей\'bb за "+
                                          Str(ГодЛетописи)+" год\b0";
    end;
    for j = 1..УказательУДК.Count                       do
      if УказательУДК[j].ИндексУДК.ВклОгл = true        then
      КодОгл    = УказательУДК[j].ИндексУДК.Код;
      НаимОгл   = УказательУДК[j].ИндексУДК.Наим;
        if      КодОгл  = "0"   or  КодОгл  = "1"       or
                КодОгл  = "2"   or  КодОгл  = "3"       or
                КодОгл  = "4"   or  КодОгл  = "5"       or
                КодОгл  = "6"   or  КодОгл  = "7"       or
                КодОгл  = "8"   or  КодОгл  = "9"       or
                КодОгл  = "7/9"                         then
    i                                   = Record.Содержание.Add;
    Record.Содержание[i].Глава          = КодОгл+"\tab\b "+НаимОгл+"\b0";
        else
    i                                   = Record.Содержание.Add;
    Record.Содержание[i].Глава          = КодОгл+"\tab "+НаимОгл;
        end;--конец условия на выделение УДК жирным шрифтом
      Record.Содержание[i].ИндексУДК    = УказательУДК[j].ИндексУДК;
      end;--конец условия на включение в ЛГС
    end;--конец цикла по УДК
    i                                   = Record.Содержание.Add;
    Record.Содержание[i].Глава          = "\b Именной указатель\b0";
    i                                   = Record.Содержание.Add;
    Record.Содержание[i].Глава          = "\b Географический указатель\b0";
    i                                   = Record.Содержание.Add;
    Record.Содержание[i].Глава          = "\b Список газет, материалы из которых отражены в № "+
                                          Str(ВыпускЛетописи)+
                                          " \'abЛетописи газетных статей\'bb\b0";
    i                                   = Record.Содержание.Add;
    Record.Содержание[i].Глава          = "Нумерационный указатель библиографических записей статей, на которые изданы карточки";
    if ВыпускЛетописи=1                                 then
      i                                 = Record.Содержание.Add;
    Record.Содержание[i].Глава          = "Перечень рубрик УДК, используемых при оформлении раздела "+
                                          "\'abСодержание\'bb ГБУ\b0";
    end;
    if ВыпускЛетописи=52                                then
      i                                 = Record.Содержание.Add;
    Record.Содержание[i].Глава          = "Указатель временных тематических рубрик в "+
                                          "\'abЛетописи газетных статей\'bb № 1 - 52 за "+Str(ГодЛетописи)+" год\b0";
    end;


    --2. Подсчет вероятного количества строк и нумерация страниц
    --НомерСтраницы                       = 1;    --это титульный лист (не нумеруется, но считается)
    --а. Сколько страниц в самом содержании?
    НомерСтроки                         = 3;    --это слово "содержание" и сепараторы - пустые сторки сверху и снизу
    for j = 1..Содержание.Count                         do
      НомерСтроки                       = НомерСтроки+Int(1+Trunc(Length(Содержание[j].Глава)/70));
    end;
    СтраницВСодержании                  = Int(1+Trunc(НомерСтроки/35));

    --б. Сколько страниц в списке газет и предисловии?
    if ВыпускЛетописи=1                                 then
    СтраницВПредисловии                 = 1;    --всегда в первом номере, никогда - в других
    НомерСтроки                         = 3;    --это заголовок раздела
      Q                 = Query.Create([РКП_Газеты.Газета]);
      Q.Filter          = "РосписьСтатей=true and ПриложениеКГазете=nil";
      Q.Select;
      if  Q.Count>0                                     then
        Q.First;
        for k = 1..Q.Count                              do
          TestStr       = "";
          TestStr       = Q.Current.НазваниеЛГС;
          if Q.Current.Подзаголовок<>nil                then
            TestStr     = TestStr+" : "+Q.Current.Подзаголовок;
          end;
          if Q.Current.МестаИздания.Count>0             then
            if Q.Current.МестаИздания.Items[1].МестоИздания.НаимБибл<>nil       then
              TestStr   = TestStr+" - "+Q.Current.МестаИздания.Items[1].МестоИздания.НаимБибл;
            else
              TestStr   = TestStr+" - "+Q.Current.МестаИздания.Items[1].МестоИздания.Наим+".";
            end;
          end;
          if Q.Current.ISSN<>nil                        then
            TestStr     = TestStr+" - ISSN "+Q.Current.ISSN;
          end;
        НомерСтроки     = НомерСтроки+Int(1+Trunc(Length(TestStr)/70));
        end;
      Q.Next;
      end;
      Q.Close;
    СтраницВСпискеГодГазет      =  Int(1+Trunc(НомерСтроки/35));
    end;
    -- в. Сколько всего страниц в статьях?
    Q                           = Query.Create([РКП_Статьи.Роспись]);
    Q.Filter                    = "ГодЛетописи="+Str(ГодЛетописи)+
                                  " and ВыпускЛетописи="+Str(ВыпускЛетописи);
    Q.Select;
    Q.First;
    НомерСтроки                 = 0;
     for k = 1..Q.Count                                 do
       НомерСтроки              = НомерСтроки+Q.Current.КолСтрокЛГС+1;
       Q.Next;
     end;
    Q.Close;
    СтраницСтатей               = Int(1+Trunc(НомерСтроки/40));

    -- г. Сколько страниц в разных указателях?
    СтраницИУ                   = Int(1+Trunc(УказательИмен.Count/90));
    СтраницГУ                   = Int(1+Trunc(УказательГео.Count/25));
    СтраницВСпискеНомерГазет    = Int(1+Trunc(УказательГазет.Count/25));

    -- д. Нумерация разделов основного текста. Подсчет строк в статьях.
    for j = 1..Содержание.Count                                         do
      if    Pos("Предисловие",Содержание[j].Глава)>0                    then
        Содержание[j].Страница  = 1+СтраницВСодержании+1;
      elsif Pos("из которых отражаются",Содержание[j].Глава)>0          then
        Содержание[j].Страница  = 1+СтраницВСодержании+2;
      elsif Pos("Именной указатель",Содержание[j].Глава)>0              then
        Содержание[j].Страница  = 1+
                                  СтраницВСодержании+
                                  СтраницВПредисловии+
                                  СтраницВСпискеГодГазет+
                                  СтраницСтатей+
                                  1;
      elsif Pos("Географический указатель",Содержание[j].Глава)>0       then
        Содержание[j].Страница  = 1+
                                  СтраницВСодержании+
                                  СтраницВПредисловии+
                                  СтраницВСпискеГодГазет+
                                  СтраницСтатей+
                                  СтраницИУ+
                                  1;
      elsif Pos("из которых отражены",Содержание[j].Глава)>0            then
        Содержание[j].Страница  = 1+
                                  СтраницВСодержании+
                                  СтраницВПредисловии+
                                  СтраницВСпискеГодГазет+
                                  СтраницСтатей+
                                  СтраницИУ+
                                  СтраницГУ+
                                  1;
      elsif Pos("Нумерационный указатель",Содержание[j].Глава)>0        then
        Содержание[j].Страница  = 1+
                                  СтраницВСодержании+
                                  СтраницВПредисловии+
                                  СтраницВСпискеГодГазет+
                                  СтраницСтатей+
                                  СтраницИУ+
                                  СтраницГУ+
                                  СтраницВСпискеНомерГазет+
                                  1;
      elsif Pos("Перечень рубрик УДК",Содержание[j].Глава)>0            then
        Содержание[j].Страница  = 1+
                                  СтраницВСодержании+
                                  СтраницВПредисловии+
                                  СтраницВСпискеГодГазет+
                                  СтраницСтатей+
                                  СтраницИУ+
                                  СтраницГУ+
                                  СтраницВСпискеНомерГазет+
                                  1+1;
      elsif Pos("Указатель временных",Содержание[j].Глава)>0            then
        Содержание[j].Страница  = 1+
                                  СтраницВСодержании+
                                  СтраницВПредисловии+
                                  СтраницВСпискеГодГазет+
                                  СтраницСтатей+
                                  СтраницИУ+
                                  СтраницГУ+
                                  СтраницВСпискеНомерГазет+
                                  1+1;
      else
        СтраницДоРаздела        = 0;
        НомерСтроки             = 0;
        Q                       = Query.Create([РКП_Статьи.Роспись]);
        Q.Filter                = "ГодЛетописи="+Str(ГодЛетописи)+
                                  " and ВыпускЛетописи="+Str(ВыпускЛетописи)+
                                  " and (ИндексУДК.Exists(РубрикаУДК.КодУДК<'"+
                                  Содержание[j].ИндексУДК.Код+"'))";
        Q.Select;
        Q.First;
         for k = 1..Q.Count                                             do
           if Q.Current.ИндексУДК.Count>0                               then
             if Q.Current.ИндексУДК.Items[1].РубрикаУДК.КодУДК<Содержание[j].ИндексУДК.Код then
               НомерСтроки      = НомерСтроки+Q.Current.КолСтрокЛГС+1;
             end;
           end;
           Q.Next;
         end;
        Q.Close;
        СтраницДоРаздела        = Int(1+Trunc(НомерСтроки/44));
        Содержание[j].Страница  = 1+
                                  СтраницВСодержании+
                                  СтраницВПредисловии+
                                  СтраницВСпискеГодГазет+
                                  СтраницДоРаздела+
                                  1;
      end;
    end;
  end;--процедуры
--}

end