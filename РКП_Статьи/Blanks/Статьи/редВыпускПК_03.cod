class inherited – ѕ_—татьи.—татьи.ред¬ыпускѕ _02 "ѕодготовка выпуска ѕ  - экспорт в – ѕ", editor ¬ыпускѕ ;
Import – ѕ_—»— Classes StdCode;

inclass

inobject

--------------------------------------------------------------------------------
--{ ќбработчики событий бланка
  proc ‘ормирование‘айла;
  var а»м€ѕапки         : string;
  var а»м€‘айла         : string;
  var а‘айл             : TextFile;
  var Q                 : Query;
  var k,kk              : integer;
  var z,zz              : integer;
  var Ўифр¬ыпуска_      : string;
  var CurrentTxt        : string;
  а»м€ѕапки             = ѕапка‘айлаЁкспорта;
  а»м€‘айла             = ‘айлЁкспорта;
------ѕроверка шифра (13.01.2009)----------------------------------------------------------------------------
--   Ўифр¬ыпуска_        = "G"+
--                       SubStr(Str(Year(ƒата¬ыпуска)),3,2)+
--                       FixStr(Str(¬ыпуск арточек),"0",3);
--   if Ўифр¬ыпуска<>Ўифр¬ыпуска_                         then
--     Ўифр¬ыпуска        = Ўифр¬ыпуска_;
--   end;
----ѕроверка шифра (29.01.2009)----------------------------------------------------------------------------
   Hint("—оздание файла...",1,4);
   Ўифр¬ыпуска_        = "Gk"+
                       SubStr(Str(Year(ƒата¬ыпуска)),3,2)+
                       FixStr(Str(¬ыпускЋетописи),"0",2)+
                       FixStr(Str(¬ыпуск арточекЋ),"0",2);
   if Ўифр¬ыпуска<>Ўифр¬ыпуска_                         then
     Ўифр¬ыпуска        = Ўифр¬ыпуска_;
   end;
----—оздание файла-----------------------------------------------------------------------------------------
    Hint("—оздание файла...",2,4);
    if    ExistFolder(а»м€ѕапки) = false                then
         CreateFolder(а»м€ѕапки);
    end;
    if  ExistFile(а»м€‘айла) = true                     then
         RemoveFile(а»м€‘айла);
    end;
    а‘айл       = TextFile.Create(а»м€‘айла,fmCreate,false);--DOS 28.01.2009
----Ќаполнение файла содержимым----------------------------------------------------------------------------
    Hint("—оздание файла...",3,4);
      Q                         = Query.Create([– ѕ_—татьи.–оспись]);
      Q.Filter                  = "Year(ƒата арточек)="+Str(Year(ƒата¬ыпуска))+
                                  " and ƒата арточек="+Str(ƒата¬ыпуска)+
                                  " and ¬ыпуск арточек="+Str(¬ыпуск арточек);
      Q.Order                   = "Ќомер«аписи¬¬ыпускеѕ ";
      Q.Select;
      kk                        = Q.Count;
      if  kk > 0                                        then
        Q.First;
--                а‘айл.WriteLn(FixStr(Str(Year(Now)),"0",2)+
--                              FixStr(Str(Mon(Now)),"0",2)+
--                              FixStr(Str(Day(Now)),"0",2)+
--                              FixStr(Str(Hour(Now)),"0",2)+
--                              FixStr(Str(Minute(Now)),"0",2));          --идентификатор (дата и врем€ создани€)
        for k = 1..kk                                   do
                --а‘айл.WriteLn("000 "+FixStr(Str(k),"0",8));
                а‘айл.WriteLn("000"+FixStr(Str(k),"0",8));--без пробела 28.01.2009
                а‘айл.WriteLn("001 ѕ√");
                а‘айл.WriteLn("003 GL"+
                              SubStr(Str(Year(ƒата¬ыпуска)),3,2)+
                              "-"+
                              FixStr(Str(¬ыпускЋетописи),"0",2)+
                              " ^1 "+Ўифр¬ыпуска);
          zz                   = Q.Current.Ёкспорт– ѕ.Count;
            for z = 1..zz                               do
              if Length(Q.Current.Ёкспорт– ѕ.Items[z].ƒанные)>4      then
              if Pos('053 ',Q.Current.Ёкспорт– ѕ.Items[z].ƒанные)<>1 then
                if Pos('^',Q.Current.Ёкспорт– ѕ.Items[z].ƒанные)>0   then
                  CurrentTxt    = ќригиналћакет.ќбработка“екста.«амена–егистра»дентификаторов(Q.Current.Ёкспорт– ѕ.Items[z].ƒанные);
                  --CurrentTxt    = ќригиналћакет.ќбработка“екста. одировка—пец—имволовDOS(CurrentTxt);
                  а‘айл.WriteLn(CurrentTxt);
                #Warning "”далить во второй половине 2009 года";
                else
                  --CurrentTxt    = ќригиналћакет.ќбработка“екста. одировка—пец—имволовDOS(Q.Current.Ёкспорт– ѕ.Items[z].ƒанные);
                  CurrentTxt    = Q.Current.Ёкспорт– ѕ.Items[z].ƒанные;
                  а‘айл.WriteLn(CurrentTxt);
                end;
              end;
              end;
            end;
                а‘айл.WriteLn("011 "+Str(Q.Current.Ќомер«аписи¬¬ыпускеѕ ));
                --а‘айл.WriteLn("015 ");--
                #Warning "ѕоле 015 в файле карточек не формируетс€, т.к. на момент создани€ файла летопись, скорее всего, не сверстана";
                --а‘айл.WriteLn("053 "+Str(Q.Current.ƒата арточек));
                а‘айл.WriteLn("016 "+Str(Q.Current.ƒата арточек));
                а‘айл.WriteLn("_");
          Q.Next;
        end;

      end;
    Hint("—оздание файла...",4,4);
    --ExecuteProgram(а»м€ѕапки);
  end;
--}

end