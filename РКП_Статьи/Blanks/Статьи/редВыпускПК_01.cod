class inherited СИС2.БазовыйБланкРедактор "Подготовка выпуска ПК - нумерация", editor ВыпускПК;
Import РКП_СИС Classes StdCode;

inclass

inobject
секцСортировкаКарточек:TemplateSection;
КодУдк_[]       : integer;
Заголовок_[]    : string;
Запись_[]       : record;

   ШифрВыпуска_        : string  = "Gk"+
                                   SubStr(Str(Year(ДатаВыпуска)),3,2)+
                                   FixStr(Str(ВыпускЛетописи),"0",2)+
                                   FixStr(Str(ВыпускКарточекЛ),"0",2);

  ПапкаКарточек         : string = "C:\МАКЕТ\ПК\"+Str(Year(ДатаВыпуска))+"\"+Str(Mon(ДатаВыпуска));
  ФайлКарточек          : string = "C:\МАКЕТ\ПК\"+Str(Year(ДатаВыпуска))+"\"+Str(Mon(ДатаВыпуска))+
                                   "\"+SubStr(ШифрВыпуска_,3,7)+
                                   "\ПК.rtf";
  ПапкаФайлаЭкспорта    : string = "C:\ЭКСПОРТ\ПК\"+Str(Year(ДатаВыпуска))+"\"+Str(Mon(ДатаВыпуска));
  ФайлЭкспорта          : string = "C:\ЭКСПОРТ\ПК\"+Str(Year(ДатаВыпуска))+"\"+Str(Mon(ДатаВыпуска))+
                                   "\Gk"+SubStr(Str(Year(ДатаВыпуска)),3,2)+
                                   FixStr(Str(ВыпускЛетописи),"0",2)+
                                   FixStr(Str(ВыпускКарточекЛ),"0",2)+
                                   ".rlg";


--------------------------------------------------------------------------------
--{ Обработчики событий бланка
  func Нумерация                :integer;
     --1.Проверить, что нет выпусков, сверстаных позже
     --2.Проверить, что нет выпусков, НЕ сверстаных ранее
     --3.Найти последний номер выпуска и вычислить +1
     --4.Найти последний номер карточек
     --5.Пронумеровать
    var Q                       : Query;
    var РешениеПродолжить       : logical;
    var ПоследнийНомер,kk,k     : integer;
    var aRecord                 : Record;
    var ГодЛетописи_0           : integer;
    var ВыпускЛетописи_0        : integer;
    var ResI                    : integer;
    РешениеПродолжить       = false;
--        --0. Фиксация имени файла-------------------
--  ПапкаКарточек          = "C:\МАКЕТ\ПК\"+Str(Year(ДатаВыпуска))+"\"+Str(Mon(ДатаВыпуска));
--  ФайлКарточек           = "C:\МАКЕТ\ПК\"+Str(Year(ДатаВыпуска))+"\"+Str(Mon(ДатаВыпуска))+
--                          "\"+SubStr(ШифрВыпуска,3,7)+
--                          "\ПК.rtf";

        --1.Проверить, что нет выпусков, сверстаных позже
    Q                           = Query.Create([РКП_Статьи.ВыпускПК]);
    Q.Filter                    = 'Year(ДатаВыпуска)='+Str(Year(ДатаВыпуска))+
                                  ' and ДатаВыпуска>'+Str(ДатаВыпуска)+
                                  ' and ВыпускСверстан=true'+
    ------------------------------02.10.2009
                                  ' and isGroup<>-1'+
                                  ' and ДатаВыпуска<>nil';

    Q.Select;
    if      Q.Count>0                   then
      Message("В базе данных имеются сверстанные выпуски карточек, выходящие позже редактируемого. "+
              "Если эти выпуски были сверстаны ошибочно, сбросьте флаг <Выпуск сверстан> во всех выпусках "+
              "этого года, датированных позже "+Str(ДатаВыпуска)+".");
      РешениеПродолжить         = false;
    else
      РешениеПродолжить         = true;
    end;
    Q.Close;
    ---
    --2.Проверить, что нет выпусков, НЕ сверстаных ранее
    if РешениеПродолжить        = true  then
      Q                         = Query.Create([РКП_Статьи.ВыпускПК]);
      Q.Filter                  = "Year(ДатаВыпуска)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаВыпуска<"+Str(ДатаВыпуска)+
                                  " and ВыпускСверстан=false";
      Q.Select;
      if      Q.Count>0                 then
        Message("В базе данных имеются не сверстанные выпуски карточек, выходящие ранее редактируемого. "+
                "Обработка этого выпуска невозможна без обработки предыддущих!");
      РешениеПродолжить         = false;
      else
        РешениеПродолжить       = true;
      end;
      Q.Close;
    end;
    --
      --проверка на факт завершения работы над выпуском летописи
    if РешениеПродолжить = true         then
      Q                         = Query.Create([РКП_Статьи.Роспись]);
      Q.Filter                  = "Year(ДатаКарточек)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаКарточек="+Str(ДатаВыпуска)+
                                  " and СтатусГЛ=true";
      Q.Select;
      if Q.Count > 0                    then
        Q.Last;
        Message("Карточки за дату "+Str(ДатаВыпуска)+" входят в летопись, №"    +
                Str(Q.Current.ВыпускЛетописи)+
                ", работа над которой завершена. Если требуется продолжить "    +
                "работу над выпуском, сбросьте флаг <летопись сверстана> "      +
                "в записи <Выпуск ЛГС №>"+Str(Q.Current.ВыпускЛетописи)+". "    +
                "В этом случае следует заново сформировать оригинал-макет летописи.");
        РешениеПродолжить       = false;
      end;
    end;
    --3.1 Найти последний номер выпуска и вычислить +1
    if РешениеПродолжить        = true  then
      Q                         = Query.Create([РКП_Статьи.ВыпускПК]);
      Q.Filter                  = "Year(ДатаВыпуска)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаВыпуска<"+Str(ДатаВыпуска)+
                                  " and ВыпускСверстан=true"+
    ------------------------------02.10.2009
                                  ' and isGroup<>-1'+
                                  ' and ВыпускКарточек>0';
      Q.Order                   = "ДатаВыпуска";
      Q.Select;
      if      Q.Count>0                 then
        Q.Last;
        ВыпускКарточек          = Q.Current.ВыпускКарточек + 1;
      else
        ВыпускКарточек          = 1;
      end;
      Q.Close;
    end;
    --3.2 Найти последний номер выпуска в пределах летописи и вычислить +1
    --if РешениеПродолжить        = true  then
      Q                         = Query.Create([РКП_Статьи.ВыпускПК]);
      Q.Filter                  = "Year(ДатаВыпуска)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаВыпуска<"+Str(ДатаВыпуска)+
                                  " and ВыпускСверстан=true"+
                                  " and ВыпускЛетописи="+Str(ВыпускЛетописи)+
    ------------------------------02.10.2009
                                  ' and isGroup<>-1';
      Q.Order                   = "ДатаВыпуска";
      Q.Select;
      if      Q.Count>0                 then
        Q.Last;
        ВыпускКарточекЛ         = Q.Current.ВыпускКарточекЛ + 1;
      else
        ВыпускКарточекЛ         = 1;
      end;
      Q.Close;
    --end;
    --4.Найти последний номер карточек
    if РешениеПродолжить        = true  then
      Q                         = Query.Create([РКП_Статьи.Роспись]);
      Q.Filter                  = "Year(ДатаКарточек)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаКарточек<"+Str(ДатаВыпуска)+
                                  " and НомерЗаписиВВыпускеПК>0"+
    ------------------------------02.10.2009
                                  ' and isGroup<>-1';
      Q.Order                   = "ДатаКарточек;НомерЗаписиВВыпускеПК";
      Q.Select;
      if Q.Count > 1                    then
        Q.Last;
        ПоследнийНомер          = Q.Current.НомерЗаписиВВыпускеПК;
      else
        ПоследнийНомер          = 0;
      end;
      Q.Close;
    end;
      -----------------------------------------------
      --5.  Собственно процесс нумерации
    if РешениеПродолжить = true         then
      КодУдк_           = nil;
      Заголовок_        = nil;
      Запись_           = nil;
      Q                         = Query.Create([РКП_Статьи.Роспись]);
      Q.Filter                  = "Year(ДатаКарточек)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаКарточек="+Str(ДатаВыпуска)+
                                  " and СтатусГЛ=false"+
    ------------------------------02.10.2009
                                  ' and isGroup<>-1';
      Q.Order                   = "НазваниеОсн;ДатыВыхода";
      Q.LoadingFields           = "ВыпускКарточек;ШифрКарточек;НомерЗаписиВВыпускеПК";
      Q.Select;
        kk                      = Q.Count;
        Q.First;
          for k = 1..kk         do
            Hint("Нумерация...",k,Q.Count);
            aRecord             = Q.Current;
            aRecord.ВыпускКарточек              = ВыпускКарточек;
            --aRecord.НомерЗаписиВВыпускеПК       = ПоследнийНомер + k;
            aRecord.ШифрКарточек                = "G"+
                                                  SubStr(Str(Year(ДатаВыпуска)),3,2)+
                                                  FixStr(Str(Q.Current.ВыпускКарточек),"0",3);
--            aRecord.ШифрКарточек                = "gk"+
--                                                  SubStr(Str(Year(ДатаВыпуска)),3,2)+
--                                                  FixStr(Str(Q.Current.ВыпускЛетописи),"0",2)+
--                                                  --FixStr(Str(Q.Current.ВыпускКарточек),"0",2);
--                                                  FixStr(Str(Q.Current.ВыпускКарточек),"0",3); #Warning "Номер выпуска карточек представлен здесь в трехсимвольном формате, т.к. в течение года выпусков более 99";

            --ПоследнийНомер                      = ПоследнийНомер + 1;
            --aRecord.НомерЗаписиВВыпускеПК       = ПоследнийНомер;
            if (aRecord.State = Record.Edited)  then
              aRecord.Post;
            end;
            --КодУдк_[k]          = Q.Current.ИндексУДК.Items[1].РубрикаУДК.Код;
            КодУдк_[k]          = Q.Current.ИндексУДК.Items[1].РубрикаУДК.Номер; --10.01.2009
            Заголовок_[k]       = Q.Current.Заголовок;
            Запись_[k]          = Q.Current;
            Q.Next;
          end;
        --Message("Пронумеровано "+Str(kk)+" статей.");
        ResI                                    = kk;
      Q.Close;
      секцСортировкаКарточек.Count=kk;
      --секцСортировкаКарточек.SortBy("КодУдк_,Заголовок_");
      секцСортировкаКарточек.SortBy("КодУдк_+,Заголовок_");
      for k = 1..kk             do
        Запись_[k].НомерЗаписиВВыпускеПК        = ПоследнийНомер + k;
      end;
    end;
      --6.  Проверка факта, что все карточки принадлежат одному выпуску летописи
    if РешениеПродолжить = true         then
      Q                         = Query.Create([РКП_Статьи.Роспись]);
      Q.Filter                  = "Year(ДатаКарточек)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаКарточек="+Str(ДатаВыпуска)+
                                  " and ВыпускКарточек="+Str(ВыпускКарточек)+
    ------------------------------02.10.2009
                                  ' and isGroup<>-1';
      Q.Select;
        kk                      = Q.Count;
        if kk > 1                       then
        Q.First;
        ГодЛетописи_0           = Q.Current.ГодЛетописи;
        ВыпускЛетописи_0        = Q.Current.ВыпускЛетописи;
        if ВыпускЛетописи<>ВыпускЛетописи_0     then
          ВыпускЛетописи        = ВыпускЛетописи_0;
        end;
        Q.Next;
          for k = 2..kk         do
            if Q.Current.ГодЛетописи<>   ГодЛетописи_0          or
               Q.Current.ВыпускЛетописи<>ВыпускЛетописи_0       then
               Enquiry ("Предупреждение","Карточки принадлежат к разным выпускам летописи!",["Закрыть"],1,System.IconType(0));
            end;
            Q.Next;
          end;
          if k = kk+1           then
--            ШифрВыпуска         = "gk"+
--                                SubStr(Str(Year(ДатаВыпуска)),3,2)+
--                                FixStr(Str(ВыпускЛетописи_0),"0",2)+
--                                FixStr(Str(ВыпускКарточек),"0",3); #Warning "Номер выпуска карточек представлен здесь в трехсимвольном формате, т.к. в течение года выпусков более 99";
--            ШифрВыпуска         = "G"+
--                                SubStr(Str(Year(ДатаВыпуска)),3,2)+
--                                FixStr(Str(ВыпускКарточек),"0",3);
            if ШифрВыпуска<>ШифрВыпуска_                         then
              ШифрВыпуска       = ШифрВыпуска_;
            end;
          end;   --далее шифр изменяется.Нужно ли вычислять его здесь?
        end;
        --#Warning 'Далее шифр изменяется.Нужно ли вычислять его здесь?';
      Q.Close;
    end;
    Return ResI;
  end;


--}

end