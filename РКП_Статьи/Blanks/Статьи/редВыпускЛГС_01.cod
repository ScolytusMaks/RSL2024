class inherited Статьи.редВыпускЛГС_00 "Подготовка выпуска ЛГС - нумерация статей", editor ВыпускЛГС;
Import РКП_СИС Classes StdCode;

inclass

inobject
  ПапкаЛетописи         : string = "C:\МАКЕТ\ЛГС\"+Str(ГодЛетописи)+"\"+Str(ВыпускЛетописи);
  ФайлЛетописи          : string = if(РКП_Статьи.ОригиналМакет.Стиль.Читка=false,
                                      "C:\МАКЕТ\ЛГС\"+Str(ГодЛетописи)+"\"+Str(ВыпускЛетописи)+"\ЛГС.rtf",
                                      "C:\МАКЕТ\ЛГС\"+Str(ГодЛетописи)+"\"+Str(ВыпускЛетописи)+"\Читка.rtf");

  ПапкаФайлаЭкспрта     : string = "C:\ЭКСПОРТ\ЛГС\"+Str(ГодЛетописи)+"\"+Str(ВыпускЛетописи);
  ФайлЭкспорта          : string = "C:\ЭКСПОРТ\ЛГС\"+Str(ГодЛетописи)+"\"+Str(ВыпускЛетописи)+
                                   "\gl"+Str(ГодЛетописи)+"-"+
                                   FixStr(Str(ВыпускЛетописи),"0",2)+
                                   ".rlg";
  var КодУдк_[]         : string;
  --var КодВремУдк_[]     : string;
  var Статья_[]         : record;
  var Заголовок_[]      : string;
  секцСортУДК           : Section;

--------------------------------------------------------------------------------
--{ Обработчики событий бланка
  func Нумерация                :integer;
    var Q                       : Query;
    var ПоследнийНомер,kk,k     : integer;
    var RezI                    : integer;
--    var VS                      : Subtable;
--    var r                       : РКП_Статьи.Роспись;
    --0.Зафиксировать имя файла

    --4.Найти последний номер
      if ВыпускЛетописи>1               then
        Q                       = Query.Create([РКП_Статьи.Роспись]);
        Q.Filter                = "ГодЛетописи="+Str(ГодЛетописи)+
                                  " and ВыпускЛетописи<="+Str(ВыпускЛетописи-1);
        Q.Order                 = "НомерЗаписиВВыпускеГЛ";
        Q.Select;
        if Q.Count > 1                  then
          Q.Last;
          ПоследнийНомер        = Q.Current.НомерЗаписиВВыпускеГЛ;
        end;
        Q.Close;
      else
        ПоследнийНомер          = 0;
      end;
      -----------------------------------------------
      --5.1 Составление временной таблицы для сортировки
      КодУдк_                   = nil;
      --КодВремУдк_               = nil;
      Статья_                   = nil;
      Заголовок_                = nil;
      секцСортУДК.Count         = 0;
        Q                       = Query.Create([РКП_Статьи.Роспись]);
        Q.Filter                = "ГодЛетописи="+Str(ГодЛетописи)+
                                  " and ВыпускЛетописи="+Str(ВыпускЛетописи);
        Q.Select;
        kk                      = Q.Count;
        RezI                    = kk;
        Q.First;
          for k = 1..kk         do      --перебор записей, сортировка п/т УДК, вывод первого (главного) кода
            Статья_[k]          = Q.Current;
            Заголовок_[k]       = Q.Current.Заголовок;
            if Q.Current.ИндексУДК.Count>0      then
              КодУдк_[k]        = Q.Current.ИндексУДК.Items[1].РубрикаУДК.КодУДК;
              КодУдк_[k]        = FixCode14(Str(Q.Current.ИндексУДК.Items[1].РубрикаУДК.Номер)); --26.12.2008
            end;
            if Q.Current.ИндексВТР<>nil         then
              КодУдк_[k]        = Q.Current.ИндексВТР.КодУДК;
              КодУдк_[k]        = FixCode14(Str(Q.Current.ИндексВТР.Номер));--26.12.2008
            end;
          Q.Next;
          end;
        Q.Close;
      --5.2 Сортировка подтаблицы
      секцСортУДК.Count         = kk;
      секцСортУДК.SortBy("КодУдк_,Заголовок_");
      --5.3 Нумерация статей
      for k = 1..kk             do
        Статья_[k].НомерЗаписиВВыпускеГЛ           = ПоследнийНомер + k;
        if k = 1                then
          ПервыйНомерСтатьи     = Статья_[k].НомерЗаписиВВыпускеГЛ;
        end;
        if k = kk               then
          ПоследнийНомерСтатьи  = Статья_[k].НомерЗаписиВВыпускеГЛ;
        end;
      end;
      --6. Вычисление количества строк
      for k = 1..kk             do
        Статья_[k].КолСтрокЛГС          = РКП_Статьи.ВыпЛГС.КолСтрокСтатьиВЛГС
                                         (ПоследнийНомер + k,
                                          Статья_[k].Заголовок,
                                          Статья_[k].ОписаниеСтатьи);
      end;
      --7.  Составление шифра летописи
      ШифрВыпуска               = "GL"+
                                SubStr(Str(ГодЛетописи),3,2)+"-"+
                                FixStr(Str(ВыпускЛетописи),"0",2);
    Return RezI;
  end;
--}

end