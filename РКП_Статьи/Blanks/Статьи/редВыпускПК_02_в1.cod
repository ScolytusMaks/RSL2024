class inherited РКП_Статьи.Статьи.редВыпускПК_01 "Подготовка выпуска ПК - оригинал-макет", editor ВыпускПК;

inclass

inobject
--  MaxLng        : integer=900;--максимальная длина текста описания статьи на карточку
--  MinLng        : integer=830;--минимальная длина текста описания статьи на карточку (для длинных описаний)
  MaxLng        : integer=570;--максимальная длина текста описания статьи на карточку
  MinLng        : integer=510;--минимальная длина текста описания статьи на карточку (для длинных описаний)

--------------------------------------------------------------------------------
--{ Обработчики событий бланка

ПозицияПК       : integer[];
СтраницаПК      : string[];
ЗаголовкПК      : string[];
СодержаниеПК    : string[];
НомерПК         : string[];
УДКПК           : string[];
РКППК           : string[];
ББКПК           : string[];
секцПозицииПК   : TemplateSection;




  proc ФормированиеПК;
    var ПК                      : TextFile;
    var Q                       : Query;
    var k,l,sk                  : integer;
    var z,zz,dlt                : integer;
    var ДлинаОписанияСтатьи     : integer;
    var iОписаниеСтатьи         : string;
    var vОписаниеСтатьи         : string;
----Создание файла-----------------------------------------------------------------------------------------
      ОригиналМакет.ПК_01_Файл.Создание(ПапкаКарточек,ФайлКарточек,ПК);
----Описание параметров всего документа--------------------------------------------------------------------
      ОригиналМакет.ПК_02_ПарамДок.Создание(ПК);
----Создание массива значений карточек---------------------------------------------------------------------
      ПозицияПК         = nil;
      СтраницаПК        = nil;
      ЗаголовкПК        = nil;
      СодержаниеПК      = nil;
      НомерПК           = nil;
      УДКПК             = nil;
      РКППК             = nil;
      ББКПК             = nil;
      Q                         = Query.Create([РКП_Статьи.Роспись]);
      Q.Filter                  = "Year(ДатаКарточек)="+Str(Year(ДатаВыпуска))+
                                  " and ДатаКарточек="+Str(ДатаВыпуска)+
                                  " and ВыпускКарточек="+Str(ВыпускКарточек);
      Q.Order                   = "НомерЗаписиВВыпускеПК";
      Q.Select;
      Q.First;
        for k = 1..Q.Count                              do      --начало цикла по статьям
          ДлинаОписанияСтатьи   = Length(Q.Current.ОписаниеСтатьи);
          if ДлинаОписанияСтатьи<MaxLng                 then
            l                   = l+1;
            ПозицияПК[l]        = l;
            СтраницаПК[l]       = "";
            СодержаниеПК[l]     = Q.Current.ОписаниеСтатьи;
            ЗаголовкПК[l]       = Q.Current.Заголовок;
            НомерПК[l]          = "№ "+Str(Q.Current.НомерЗаписиВВыпускеПК);
            УДКПК[l]            = "УДК "+Q.Current.ИндексУДК.Items[1].РубрикаУДК.Код;
            РКППК[l]            = "\'a9Рос.кн.палата "+Str(Q.Current.ДатаКарточек);
            ББКПК[l]            = "ББК "+Q.Current.ИндексББК.Items[1].РубрикаББК.Код;
          else
            iОписаниеСтатьи     = Q.Current.ОписаниеСтатьи;
            zz                  = Length(iОписаниеСтатьи);
            vОписаниеСтатьи     = "";
            sk                  = 0;
            for z = 1..zz                                       do      --цикл по символам описания
              if Mod(z,MinLng)=0                                then    --условие кратности 830
                dlt             = 0;                                    --дельта (приращение) = 0
                for dlt= 1..40                                  do      --цикл по символам остатка описания (для поиска места для разрыва строки)
                  if SubStr(iОписаниеСтатьи,z-1+dlt,1)=" "      then    --условие разрыва
            l                   = l+1;
            sk                  = sk+1;
            ПозицияПК[l]        = l;
            СтраницаПК[l]       = Str(sk);
            --СодержаниеПК[l]     = vОписаниеСтатьи+"\par\par\qr {см. след. карт} \par\qj\line";
            СодержаниеПК[l]     = vОписаниеСтатьи+"\par\line\qr {см. след. карт} \par\qj";
            ЗаголовкПК[l]       = Q.Current.Заголовок;
            НомерПК[l]          = "№ "+Str(Q.Current.НомерЗаписиВВыпускеПК);
            УДКПК[l]            = "УДК "+Q.Current.ИндексУДК.Items[1].РубрикаУДК.Код;
            РКППК[l]            = "\'a9Рос.кн.палата "+Str(Q.Current.ДатаКарточек);
            ББКПК[l]            = "ББК "+Q.Current.ИндексББК.Items[1].РубрикаББК.Код;
                    vОписаниеСтатьи     = "";
                    z=z+dlt;
                    break;
                  else                                                  --условие продолжения поиска маста для разрыва
                      vОписаниеСтатьи   = vОписаниеСтатьи+SubStr(iОписаниеСтатьи,z-1+dlt,1);
                  end;
                end;
              end;
              vОписаниеСтатьи   = vОписаниеСтатьи+SubStr(iОписаниеСтатьи,z,1);
              if z=zz                                           then    --условие формирования финальной карточки
            l                   = l+1;
            sk                  = sk+1;
            ПозицияПК[l]        = l;
            СтраницаПК[l]       = Str(sk);
            СодержаниеПК[l]     = vОписаниеСтатьи;
            ЗаголовкПК[l]       = Q.Current.Заголовок;
            НомерПК[l]          = "№ "+Str(Q.Current.НомерЗаписиВВыпускеПК);
            УДКПК[l]            = "УДК "+Q.Current.ИндексУДК.Items[1].РубрикаУДК.Код;
            РКППК[l]            = "\'a9Рос.кн.палата "+Str(Q.Current.ДатаКарточек);
            ББКПК[l]            = "ББК "+Q.Current.ИндексББК.Items[1].РубрикаББК.Код;
              vОписаниеСтатьи   = "";
              end;
            end;
          end;
          Q.Next;
        end;--конец цикла по статьям
        секцПозицииПК.Count     = l;
      Q.Close;
----Формирование карточек на основе массива----------------------------------------------------------------
    for k = 1..секцПозицииПК.Count step 2                       do
      if Mod(k-1,10)=0 and k>1                                  then--условие кратности 10
                ПК.WriteLn("\sect");--разрыв страницы
      end;--условие кратности 10
      if k+1<секцПозицииПК.Count                                then
      --~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      ОригиналМакет.ПК_03_ПараФорм.Создание(ПК,
                                            СтраницаПК[k],
                                            ЗаголовкПК[k],
                                            СодержаниеПК[k],
                                            НомерПК[k],
                                            УДКПК[k],
                                            РКППК[k],
                                            ББКПК[k],
                                            --
                                            СтраницаПК[k+1],
                                            ЗаголовкПК[k+1],
                                            СодержаниеПК[k+1],
                                            НомерПК[k+1],
                                            УДКПК[k+1],
                                            РКППК[k+1],
                                            ББКПК[k+1]
                                            );
      --~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      else
      --~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      ОригиналМакет.ПК_03_ПараФорм.Создание(ПК,
                                            СтраницаПК[k],
                                            ЗаголовкПК[k],
                                            СодержаниеПК[k],
                                            НомерПК[k],
                                            УДКПК[k],
                                            РКППК[k],
                                            ББКПК[k],
                                            --
                                            "",
                                            "",
                                            "",
                                            "",
                                            "",
                                            "",
                                            ""
                                            );
      --~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      end;
    end;
                ПК.WriteLn("}");--засыкающая скобка-конец текста RTF
 end;--ФормированиеПК; v3






--}

end