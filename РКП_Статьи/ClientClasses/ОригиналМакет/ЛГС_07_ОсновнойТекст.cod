class "";

inclass

  proc Создание (ЛГС :TextFile; ЗаписьЛГС :ВыпускЛГС);
    var j, z, u, g :Integer;
    var КодОгл, НаимОгл, НаимОгл_ :String;
    var СтрокаОтсылок, СтрокаЗаголовка, СтрокаОснТекста :String;
    var Q :Query;
    var локСтатья :РКП_Статьи.Роспись;
    var локРубрикаУДК, локИндексУДК, локИндексВТР :РКП_Справочники.СпрТематикаСтатьи;


    ЛГС.WriteLn("\page");
    ЛГС.WriteLn("\pard" + ОригиналМакет.Стиль.styl0 + "\par\par\par\par\par\ds0");
    for j = 1 .. ЗаписьЛГС.УказательУДК.Count do -- начало цикла по УДК (весь указатель)
      КодОгл  = ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК.Код;
      НаимОгл = ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК.Наим;
      if (КодОгл in ['0','1','2','3','4','5','6','7','8','9','7/9']) then -- условие выделения прописными буквами основных разделов ЛГС
        НаимОгл = Up(НаимОгл);
      fi;
      ЛГС.WriteLn("\par\pard" + ОригиналМакет.Стиль.styl2 + "\qc ");
      if (not ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК.БезКода) then -- условие вывода кода УДК
        ЛГС.WriteLn("{\b " + КодОгл + " " + НаимОгл + "\b0}");
      else
        if (not ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК.Временная) then -- условие вывода курсивом временных рубрик
          НаимОгл_ = ""; -- условие вывода в разрядку
          for u = 1 .. Length(НаимОгл) do
            НаимОгл_ = НаимОгл_ + SubStr(НаимОгл, u, 1) + " ";
          od;
          ЛГС.WriteLn("{" + НаимОгл_ + "}");
        else -- условие вывода в разрядку
          ЛГС.WriteLn("{\i " + НаимОгл + "\i0}");
        fi;
      fi; -- конец условия вывода кода УДК
      ЛГС.WriteLn("\ds2");
      Q = Query.Create([РКП_Статьи.Роспись]);
      if (not ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК.Временная) then -- условие отсечения временной рубрики
        Q.Filter = "ГодЛетописи=" + Str(ЗаписьЛГС.ГодЛетописи) +
                 " and ВыпускЛетописи=" + Str(ЗаписьЛГС.ВыпускЛетописи) +
                 " and (ИндексУДК.Exists(РубрикаУДК=" + Str(ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК) + "))" +
                 " and ИндексВТР=nil";
      else
        Q.Filter = "ГодЛетописи=" + Str(ЗаписьЛГС.ГодЛетописи) +
                 " and ВыпускЛетописи=" + Str(ЗаписьЛГС.ВыпускЛетописи) +
                 " and ИндексВТР=" + Str(ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК);
      fi;
      Q.Order = "НомерЗаписиВВыпускеГЛ";
      Q.Select;
      while not Q.Eof do -- ЦИКЛ по статьям, входящим в раздел
        локСтатья = Q.Current as РКП_Статьи.Роспись;
        if (локСтатья.ИндексУДК.Count > 0) then
          локРубрикаУДК = локСтатья.ИндексУДК.Items[1].РубрикаУДК;
          локИндексУДК  = ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК;
          локИндексВТР     = локСтатья.ИндексВТР;
          if ((локРубрикаУДК = локИндексУДК) and (локИндексВТР = nil)) or (локИндексВТР = локИндексУДК) then
            ЛГС.WriteLn ("\par" + ОригиналМакет.Стиль.styl1 + "\qj ");
            ЛГС.WriteLn ("{" + Str(локСтатья.НомерЗаписиВВыпускеГЛ) + ". }");
            ЛГС.WriteLn ("{\b ");
            СтрокаЗаголовка = локСтатья.Заголовок;
            СтрокаЗаголовка = РКП_Статьи.ОригиналМакет.ОбработкаТекста.ВставкаСпецСимволов(СтрокаЗаголовка);
            ЛГС.WriteLn (" " + СтрокаЗаголовка + " ");
            ЛГС.WriteLn ("\b0} ");
            СтрокаОснТекста = локСтатья.ОписаниеСтатьи;
            СтрокаОснТекста = РКП_Статьи.ОригиналМакет.ОбработкаТекста.ВставкаСпецСимволов(СтрокаОснТекста);
            ЛГС.WriteLn (СтрокаОснТекста);
            -- + УДК
            for z = 1 .. локСтатья.ИндексУДК.Count do
              if (z = 1) then
                ЛГС.WriteLn ("\par\qr\fs14{");
                ЛГС.Write   ("УДК " + локСтатья.ИндексУДК.Items[z].рубрикаУДК.Код);
              fi;
              if (z > 1) and (z <= локСтатья.ИндексУДК.Count) then
                ЛГС.Write   (" + " + локСтатья.ИндексУДК.Items[z].рубрикаУДК.Код);
              fi;
              if (z = локСтатья.ИндексУДК.Count) then
                ЛГС.WriteLn ("}");
              fi;
            od;
            -- + ББК
            if ЗаписьЛГС.ПечатьКодаББК then
              for z = 1 .. локСтатья.ИндексББК.Count do
                if (z = 1) then
                  ЛГС.WriteLn ("\par\qr\fs14{\b");
                  ЛГС.Write   ("ББК " + локСтатья.ИндексББК.Items[z].рубрикаББК.Код);
                fi;
                if (z > 1) and (z <= локСтатья.ИндексББК.Count) then
                  ЛГС.Write   (" + " + локСтатья.ИндексББК.Items[z].рубрикаББК.Код);
                fi;
                if (z = локСтатья.ИндексББК.Count) then
                  ЛГС.WriteLn ("\b0}");
                fi;
              od;
              -- + география
              for g = 1 .. локСтатья.ИндексГео.Count do
                if (g = 1) then
                  ЛГС.WriteLn ("\par\qr\fs14{");
                  ЛГС.Write   (локСтатья.ИндексГео.Items[g].рубрикаГео.Наим + " # " + локСтатья.ИндексГео.Items[g].ПодРубрикаСист.Наим);
                fi;
                if (g > 1) and (g <= локСтатья.ИндексГео.Count) then
                  ЛГС.Write   ("\par " + локСтатья.ИндексГео.Items[g].рубрикаГео.Наим + " # " + локСтатья.ИндексГео.Items[g].ПодРубрикаСист.Наим);
                fi;
                if (g = локСтатья.ИндексГео.Count) then
                  ЛГС.WriteLn ("}");
                fi;
              od;
              -- + Автор записи
              ЛГС.WriteLn ("\par\qr\fs14{\i");
              ЛГС.Write   ("Запись создана: " + локСтатья.CreateUser);
              ЛГС.WriteLn ("\i0}");
            fi;
            ЛГС.WriteLn ("\ds1");
          fi;
        fi;
        Q.Next;
      od; -- конец цикла в запросе по статьям
      -- #Warning "Организовать второй цикл для поиска отсылок и формирования строки отсылок по разделу (в конце раздела)";
      -- проверка всех статей, имеющих более 1 позиции УДК на вхождение в этот раздел
      Q = Query.Create([РКП_Статьи.Роспись]);
      Q.Filter = "ГодЛетописи=" + Str(ЗаписьЛГС.ГодЛетописи) +
                 " and ВыпускЛетописи=" + Str(ЗаписьЛГС.ВыпускЛетописи) +
                 " and ИндексУДК.Count>1";
      Q.Order  = "НомерЗаписиВВыпускеГЛ";
      Q.Select;
      СтрокаОтсылок = "";
      while not Q.Eof do
        локСтатья = Q.Current as РКП_Статьи.Роспись;
        for z = 2 .. локСтатья.ИндексУДК.Count do
          локРубрикаУДК = локСтатья.ИндексУДК.Items[z].рубрикаУДК;
          локИндексУДК  = ЗаписьЛГС.УказательУДК.Items[j].ИндексУДК;
          if (локРубрикаУДК = локИндексУДК) then
            if (СтрокаОтсылок = "") then
              СтрокаОтсылок = "См. " + Str(локСтатья.НомерЗаписиВВыпускеГЛ);
            else
              СтрокаОтсылок = СтрокаОтсылок + ", " + Str(локСтатья.НомерЗаписиВВыпускеГЛ);
            fi;
          fi;
        od;
        Q.Next;
      od;
      if (СтрокаОтсылок <> "") then
        ЛГС.Write   ("\par" + ОригиналМакет.Стиль.styl1 + "\ql {");
        ЛГС.Write   (СтрокаОтсылок);
        ЛГС.WriteLn ("}\ds1");
      fi;
    od; -- окончание цикла по указателю УДК
    ЛГС.WriteLn ("\par");
  end;


end